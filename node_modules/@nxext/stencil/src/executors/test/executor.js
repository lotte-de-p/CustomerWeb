"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const cli_1 = require("@stencil/core/cli");
const stencil_runtime_1 = require("../stencil-runtime");
const stencil_parameters_1 = require("../stencil-runtime/stencil-parameters");
const devkit_1 = require("@nx/devkit");
const e2e_testing_1 = require("../stencil-runtime/e2e-testing");
function createStencilCompilerOptions(taskCommand, options) {
    let runOptions = [taskCommand];
    runOptions.push(`--spec`);
    runOptions = (0, stencil_parameters_1.parseRunParameters)(runOptions, options);
    return (0, cli_1.parseFlags)(runOptions);
}
function runExecutor(options, context) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const taskCommand = 'test';
        devkit_1.logger.info(`
  ###
  ### You have to downgrade the Jest packages to Jest 27. We won't do this automatically cause it could break other Nx projects.
  ### Stencil itself supports just Jest 27, Nx uses Jest 28 by default. Downgrade with caution!
  ###
  `);
        const flags = createStencilCompilerOptions(taskCommand, options);
        const { strictConfig, pathCollection } = yield (0, stencil_runtime_1.initializeStencilConfig)(taskCommand, options, context, flags);
        const stencilConfig = yield (0, stencil_runtime_1.prepareConfigAndOutputargetPaths)(strictConfig, pathCollection);
        try {
            yield (0, stencil_runtime_1.createStencilProcess)(stencilConfig);
            if (stencilConfig.flags.e2e) {
                (0, e2e_testing_1.cleanupE2eTesting)(pathCollection);
            }
            return { success: true };
        }
        catch (err) {
            devkit_1.logger.error(err.message);
            return { success: false, error: err.message };
        }
    });
}
exports.default = runExecutor;
//# sourceMappingURL=executor.js.map