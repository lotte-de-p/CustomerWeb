import { SalesOfferProductUtil } from './sales-offer-product.util';
import { SAFE_SPOT_PRO } from '../constants/sofy.constants';
import { SalesOfferProductType, } from '../models/response';
import { concat, filter, flatMap, flatten, groupBy, isUndefined, map, min, minBy, sum, sumBy, uniqBy } from 'lodash-es';
import { SalesOfferPromoUtil } from './sales-offer-promo.util';
export class SalesOfferUtil {
    static getTotalMonthlyPrice(offer, exclusiveVat) {
        return sum([
            SalesOfferUtil.getMonthlyPriceForProducts(offer, exclusiveVat),
            SalesOfferUtil.getMonthlyPriceForSelectedProductOptions(offer, exclusiveVat),
            SalesOfferUtil.getMonthlyPriceForStandaloneOptions(offer, exclusiveVat),
        ]);
    }
    static getTotalMonthlyPriceInclPromos(offer, exclusiveVat) {
        return sum([this.getTotalMonthlyPrice(offer, exclusiveVat), this.getTotalMonthlyPromoPrice(offer, exclusiveVat)]);
    }
    static getSafeSpotProOption(offer) {
        const allSelectedProductOptions = SalesOfferUtil.getAllSelectedProductOptions(offer);
        return allSelectedProductOptions.find((option) => option.omapiid === SAFE_SPOT_PRO);
    }
    static getAllSelectedProductOptions(offer) {
        return filter(this.getAllProductOptions(offer), (o) => o.selected);
    }
    static getAllProductOptions(offer) {
        if (offer === undefined) {
            return [];
        }
        return SalesOfferUtil.getAllProductItemsByType(offer, SalesOfferProductType.OPTIONS);
    }
    static getAllSelectedProductStreamingServices(offer) {
        return filter(this.getAllProductStreamingServices(offer), (o) => o.selected);
    }
    static getAllProductStreamingServices(offer) {
        if (offer === undefined) {
            return [];
        }
        return SalesOfferUtil.getAllProductItemsByType(offer, SalesOfferProductType.STREAMING_SERVICES);
    }
    static getAllSelectedProductOptins(offer) {
        return filter(this.getAllProductOptins(offer), (o) => o.selected);
    }
    static getAllProductOptins(offer) {
        if (offer === undefined) {
            return [];
        }
        return SalesOfferUtil.getAllProductItemsByType(offer, SalesOfferProductType.OPTINS);
    }
    static getAllProductItemsByType(offer, type) {
        return uniqBy(flatten(map(offer.products, (product) => product[type])), (o) => o.omapiid);
    }
    static getMonthlyPriceForSelectedProductOptions(offer, exclusiveVat) {
        const allSelectedProductOptions = SalesOfferUtil.getAllSelectedProductOptions(offer);
        return (SalesOfferUtil.getMonthlyPriceForItems(allSelectedProductOptions, !!exclusiveVat) +
            SalesOfferUtil.getMonthlyPermanentPromoDiscountForItems(allSelectedProductOptions, !!exclusiveVat));
    }
    static getMonthlyPriceForProducts(offer, exclusiveVat) {
        return (SalesOfferUtil.getMonthlyPriceForItems(offer.products, !!exclusiveVat) +
            SalesOfferUtil.getMonthlyPermanentPromoDiscountForItems(offer.products, !!exclusiveVat));
    }
    static getMonthlyPriceForStandaloneOptions(offer, exclusiveVat) {
        return (SalesOfferUtil.getMonthlyPriceForItems(offer.standaloneoptions, !!exclusiveVat) +
            SalesOfferUtil.getMonthlyPermanentPromoDiscountForItems(offer.standaloneoptions, !!exclusiveVat));
    }
    static getMonthlyPromosForSelectedProductOptions(offer, exclusiveVat) {
        return sum(map(SalesOfferUtil.getMonthlyPromotions(SalesOfferUtil.getAllSelectedProductOptions(offer)), (p) => (exclusiveVat ? p.priceexclvat : p.price)));
    }
    static getMonthlyPromosForProducts(offer, exclusiveVat) {
        return sum(map(SalesOfferUtil.getMonthlyPromotions(offer.products), (p) => exclusiveVat ? p.priceexclvat : p.price));
    }
    static getMonthlyPromosForStandaloneOptions(offer, exclusiveVat) {
        return sum(map(SalesOfferUtil.getMonthlyPromotions(offer.standaloneoptions), (p) => exclusiveVat ? p.priceexclvat : p.price));
    }
    static getMonthlyPromos(offer) {
        return flatMap(offer.products, (product) => SalesOfferUtil.getMonthlyProductPromos(product));
    }
    static getAllPromos(offer) {
        return concat(SalesOfferUtil.getMonthlyPromos(offer), flatMap(offer.products, (product) => SalesOfferUtil.getCostPromos(product)), flatMap(offer.products, (product) => SalesOfferUtil.getInstallPromos(product)));
    }
    static findProduct(offer, omapiId) {
        return offer && offer.products ? offer.products.find((product) => product.omapiid === omapiId) : undefined;
    }
    static getCostPromos(product) {
        return flatMap(product.costs, (cost) => cost.promotions);
    }
    static getInstallPromos(product) {
        return flatMap(product.installtypes.filter((installType) => installType.selected), (installType) => installType.promos);
    }
    static getMonthlyProductPromos(product) {
        return concat(product.promos, flatMap(product.optinproducts, (optin) => optin.promos), flatMap(product.options.filter((option) => option.selected), (option) => option.promos));
    }
    static getMonthlyPromosGroupedByDuration(offer) {
        return map(groupBy(SalesOfferUtil.getMonthlyPromos(offer).filter((promo) => promo.duration > 0), (promo) => promo.duration), (promos, key) => {
            return {
                duration: Number(key),
                promos: promos,
            };
        });
    }
    static getPromoDurationGroupsTotal(salesOfferPromoGroups, exclusiveVat) {
        return sum(map(flatMap(salesOfferPromoGroups, (group) => group.promos), (promo) => (exclusiveVat ? promo.priceexclvat : promo.price)));
    }
    static getBundle(offer) {
        const bundle = offer.products.find((product) => {
            return product.productInfo && product.productInfo.isBundle();
        });
        if (!bundle) {
            throw new Error('Salesoffer does not contain a bundle');
        }
        return bundle;
    }
    static containsResidentialProduct(offer) {
        return offer.products.some((product) => SalesOfferProductUtil.isResidentialProduct(product));
    }
    static containsSohoProduct(offer) {
        return offer.products.some((product) => SalesOfferProductUtil.isSohoProduct(product));
    }
    static containsPromoTag(offer, tag) {
        return SalesOfferPromoUtil.containsTag(offer.promos, tag);
    }
    static getMonthlyPriceForItems(items, exclusiveVat) {
        return sum(map(items, (p) => (exclusiveVat ? p.priceexclvat : p.price)));
    }
    static getMonthlyPermanentPromoDiscountForItems(items, exclusiveVat) {
        return SalesOfferUtil.getPermanentPromotions(items)
            .map((promo) => SalesOfferUtil.getPrice(promo, exclusiveVat))
            .reduce((curr, previous) => curr + previous, 0);
    }
    static getPermanentPromotions(items) {
        return SalesOfferUtil.getPromotionsWithDuration(items, (promo) => promo?.duration === 0);
    }
    static getMonthlyPromotions(items) {
        return SalesOfferUtil.getPromotionsWithDuration(items, (promo) => promo?.duration > 0);
    }
    static getPromotionsWithDuration(items, durationFilter) {
        return (items || [])
            .map((item) => item.promos)
            .reduce((accumulator, value) => accumulator.concat(value), [])
            .filter(durationFilter);
    }
    static getShortestDurationOfAllPromos(salesOffer) {
        return min([
            this.getShortestPromoDurationOfProducts(salesOffer),
            this.getShortestPromoDurationOfProductOptions(salesOffer),
            this.getShortestPromoDurationOfStandaloneOptions(salesOffer),
        ]);
    }
    static getPriceInclPromo(salesOfferProduct, business) {
        return this.getPrice(salesOfferProduct, business) + sumBy(salesOfferProduct.promos, this.getPriceTag(business));
    }
    static getTotalTemporaryDiscount(salesOfferProduct, business) {
        const temporaryPromos = salesOfferProduct.promos.filter((promo) => promo.duration !== 0);
        return sumBy(temporaryPromos, this.getPriceTag(business));
    }
    static getShortestPromoDuration(salesOfferProduct) {
        return this.calculateShortestPromoDuration(salesOfferProduct.promos);
    }
    static getTotalMonthlyPromoPrice(offer, exclusiveVat) {
        return sum([
            SalesOfferUtil.getMonthlyPromosForProducts(offer, exclusiveVat),
            SalesOfferUtil.getMonthlyPromosForSelectedProductOptions(offer, exclusiveVat),
            SalesOfferUtil.getMonthlyPromosForStandaloneOptions(offer, exclusiveVat),
        ]);
    }
    static getPrice(salesOfferProduct, business) {
        return business ? salesOfferProduct.priceexclvat : salesOfferProduct.price;
    }
    static getPriceTag(business) {
        return business ? 'priceexclvat' : 'price';
    }
    static calculateShortestPromoDuration(salesOfferPromos) {
        const shortestDurationPromo = minBy(salesOfferPromos, 'duration');
        return !isUndefined(shortestDurationPromo) ? shortestDurationPromo.duration : 0;
    }
    static getShortestPromoDurationOfProducts(salesOffer) {
        return min(map(SalesOfferUtil.getMonthlyPromotions(salesOffer.products), (promo) => promo.duration));
    }
    static getShortestPromoDurationOfStandaloneOptions(salesOffer) {
        return min(map(SalesOfferUtil.getMonthlyPromotions(salesOffer.standaloneoptions), (promo) => promo.duration));
    }
    static getShortestPromoDurationOfProductOptions(salesOffer) {
        return min(map(SalesOfferUtil.getMonthlyPromotions(this.getAllSelectedProductOptions(salesOffer)), (promo) => promo.duration));
    }
    static getCosts(salesOffer, nameFilter = null) {
        const flat = (someFunction, arr) => arr.reduce((salesOfferCosts, salesOfferProduct) => [
            ...salesOfferCosts,
            ...someFunction(salesOfferProduct),
        ], []);
        const costs = flat((product) => {
            if (product.costs) {
                return product.costs;
            }
            else {
                return [];
            }
        }, salesOffer.products);
        if (nameFilter) {
            return costs.filter((cost) => cost.name === nameFilter);
        }
        return costs;
    }
    static getInstallTypes(salesOffer) {
        return flatMap(salesOffer.products, (product) => product.installtypes);
    }
    static isOrderingHighTier(salesOffer) {
        return salesOffer.products.some((product) => {
            return product.productInfo && product.productInfo.isHighTier();
        });
    }
    static containsAll(offer, omapiIds) {
        return omapiIds.every((omapiId) => this.contains(offer, omapiId));
    }
    static containsAny(offer, omapiIds) {
        return omapiIds.some((omapiId) => this.contains(offer, omapiId));
    }
    static contains(offer, omapiId) {
        return offer.products.some((product) => product.omapiid === omapiId);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FsZXMtb2ZmZXIudXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvdXRpbHMvc2FsZXMtb2ZmZXIudXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDNUQsT0FBTyxFQU9MLHFCQUFxQixHQUd0QixNQUFNLG9CQUFvQixDQUFDO0FBRTVCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4SCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUUvRCxNQUFNLE9BQU8sY0FBYztJQUNsQixNQUFNLENBQUMsb0JBQW9CLENBQUMsS0FBaUIsRUFBRSxZQUFzQjtRQUMxRSxPQUFPLEdBQUcsQ0FBQztZQUNULGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDO1lBQzlELGNBQWMsQ0FBQyx3Q0FBd0MsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDO1lBQzVFLGNBQWMsQ0FBQyxtQ0FBbUMsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDO1NBQ3hFLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxNQUFNLENBQUMsOEJBQThCLENBQUMsS0FBaUIsRUFBRSxZQUFzQjtRQUNwRixPQUFPLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLEVBQUUsSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7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QUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLENBQUM7SUFDdkUsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2FsZXNPZmZlclByb2R1Y3RVdGlsIH0gZnJvbSAnLi9zYWxlcy1vZmZlci1wcm9kdWN0LnV0aWwnO1xuaW1wb3J0IHsgU0FGRV9TUE9UX1BSTyB9IGZyb20gJy4uL2NvbnN0YW50cy9zb2Z5LmNvbnN0YW50cyc7XG5pbXBvcnQge1xuICBTYWxlc09mZmVyLFxuICBTYWxlc09mZmVyUHJpY2VkSXRlbSxcbiAgU2FsZXNPZmZlclByb2R1Y3QsXG4gIFNhbGVzT2ZmZXJQcm9kdWN0SW5zdGFsbFR5cGUsXG4gIFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW4sXG4gIFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW9uLFxuICBTYWxlc09mZmVyUHJvZHVjdFR5cGUsXG4gIFNhbGVzT2ZmZXJQcm9tbyxcbiAgU2FsZXNPZmZlclByb21vRHVyYXRpb25Hcm91cCxcbn0gZnJvbSAnLi4vbW9kZWxzL3Jlc3BvbnNlJztcbmltcG9ydCB7IFNhbGVzT2ZmZXJDb3N0IH0gZnJvbSAnLi4vbW9kZWxzL3NhbGVzT2ZmZXJDb3N0JztcbmltcG9ydCB7IGNvbmNhdCwgZmlsdGVyLCBmbGF0TWFwLCBmbGF0dGVuLCBncm91cEJ5LCBpc1VuZGVmaW5lZCwgbWFwLCBtaW4sIG1pbkJ5LCBzdW0sIHN1bUJ5LCB1bmlxQnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU2FsZXNPZmZlclByb2R1Y3RTdHJlYW1pbmdTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzL3Jlc3BvbnNlL3NhbGVzLW9mZmVyLXByb2R1Y3Qtc3RyZWFtaW5nLXNlcnZpY2UubW9kZWwnO1xuaW1wb3J0IHsgU2FsZXNPZmZlclByb21vVXRpbCB9IGZyb20gJy4vc2FsZXMtb2ZmZXItcHJvbW8udXRpbCc7XG5cbmV4cG9ydCBjbGFzcyBTYWxlc09mZmVyVXRpbCB7XG4gIHB1YmxpYyBzdGF0aWMgZ2V0VG90YWxNb250aGx5UHJpY2Uob2ZmZXI6IFNhbGVzT2ZmZXIsIGV4Y2x1c2l2ZVZhdD86IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIHJldHVybiBzdW0oW1xuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByaWNlRm9yUHJvZHVjdHMob2ZmZXIsIGV4Y2x1c2l2ZVZhdCksXG4gICAgICBTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJpY2VGb3JTZWxlY3RlZFByb2R1Y3RPcHRpb25zKG9mZmVyLCBleGNsdXNpdmVWYXQpLFxuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByaWNlRm9yU3RhbmRhbG9uZU9wdGlvbnMob2ZmZXIsIGV4Y2x1c2l2ZVZhdCksXG4gICAgXSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldFRvdGFsTW9udGhseVByaWNlSW5jbFByb21vcyhvZmZlcjogU2FsZXNPZmZlciwgZXhjbHVzaXZlVmF0PzogYm9vbGVhbik6IG51bWJlciB7XG4gICAgcmV0dXJuIHN1bShbdGhpcy5nZXRUb3RhbE1vbnRobHlQcmljZShvZmZlciwgZXhjbHVzaXZlVmF0KSwgdGhpcy5nZXRUb3RhbE1vbnRobHlQcm9tb1ByaWNlKG9mZmVyLCBleGNsdXNpdmVWYXQpXSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldFNhZmVTcG90UHJvT3B0aW9uKG9mZmVyOiBTYWxlc09mZmVyKTogU2FsZXNPZmZlclByb2R1Y3RPcHRpb24gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFsbFNlbGVjdGVkUHJvZHVjdE9wdGlvbnMgPSBTYWxlc09mZmVyVXRpbC5nZXRBbGxTZWxlY3RlZFByb2R1Y3RPcHRpb25zKG9mZmVyKTtcbiAgICByZXR1cm4gYWxsU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucy5maW5kKChvcHRpb24pID0+IG9wdGlvbi5vbWFwaWlkID09PSBTQUZFX1NQT1RfUFJPKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0QWxsU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucyhvZmZlcj86IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvZHVjdE9wdGlvbltdIHtcbiAgICByZXR1cm4gZmlsdGVyKHRoaXMuZ2V0QWxsUHJvZHVjdE9wdGlvbnMob2ZmZXIpLCAobykgPT4gby5zZWxlY3RlZCk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEFsbFByb2R1Y3RPcHRpb25zKG9mZmVyPzogU2FsZXNPZmZlcik6IFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW9uW10ge1xuICAgIGlmIChvZmZlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHJldHVybiBTYWxlc09mZmVyVXRpbC5nZXRBbGxQcm9kdWN0SXRlbXNCeVR5cGUob2ZmZXIsIFNhbGVzT2ZmZXJQcm9kdWN0VHlwZS5PUFRJT05TKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0QWxsU2VsZWN0ZWRQcm9kdWN0U3RyZWFtaW5nU2VydmljZXMob2ZmZXI/OiBTYWxlc09mZmVyKTogU2FsZXNPZmZlclByb2R1Y3RTdHJlYW1pbmdTZXJ2aWNlW10ge1xuICAgIHJldHVybiBmaWx0ZXIodGhpcy5nZXRBbGxQcm9kdWN0U3RyZWFtaW5nU2VydmljZXMob2ZmZXIpLCAobykgPT4gby5zZWxlY3RlZCk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEFsbFByb2R1Y3RTdHJlYW1pbmdTZXJ2aWNlcyhvZmZlcj86IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvZHVjdFN0cmVhbWluZ1NlcnZpY2VbXSB7XG4gICAgaWYgKG9mZmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIFNhbGVzT2ZmZXJVdGlsLmdldEFsbFByb2R1Y3RJdGVtc0J5VHlwZShcbiAgICAgIG9mZmVyLFxuICAgICAgU2FsZXNPZmZlclByb2R1Y3RUeXBlLlNUUkVBTUlOR19TRVJWSUNFU1xuICAgICkgYXMgU2FsZXNPZmZlclByb2R1Y3RTdHJlYW1pbmdTZXJ2aWNlW107XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEFsbFNlbGVjdGVkUHJvZHVjdE9wdGlucyhvZmZlcj86IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvZHVjdE9wdGluW10ge1xuICAgIHJldHVybiBmaWx0ZXIodGhpcy5nZXRBbGxQcm9kdWN0T3B0aW5zKG9mZmVyKSwgKG8pID0+IG8uc2VsZWN0ZWQpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRBbGxQcm9kdWN0T3B0aW5zKG9mZmVyPzogU2FsZXNPZmZlcik6IFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW5bXSB7XG4gICAgaWYgKG9mZmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIFNhbGVzT2ZmZXJVdGlsLmdldEFsbFByb2R1Y3RJdGVtc0J5VHlwZShvZmZlciwgU2FsZXNPZmZlclByb2R1Y3RUeXBlLk9QVElOUyk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRBbGxQcm9kdWN0SXRlbXNCeVR5cGUoXG4gICAgb2ZmZXI6IFNhbGVzT2ZmZXIsXG4gICAgdHlwZTogU2FsZXNPZmZlclByb2R1Y3RUeXBlXG4gICk6IFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW9uW10gfCBTYWxlc09mZmVyUHJvZHVjdE9wdGluW10gfCBTYWxlc09mZmVyUHJvZHVjdFN0cmVhbWluZ1NlcnZpY2VbXSB7XG4gICAgcmV0dXJuIHVuaXFCeShmbGF0dGVuKG1hcChvZmZlci5wcm9kdWN0cywgKHByb2R1Y3QpID0+IHByb2R1Y3RbdHlwZV0pKSwgKG8pID0+IG8ub21hcGlpZCk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldE1vbnRobHlQcmljZUZvclNlbGVjdGVkUHJvZHVjdE9wdGlvbnMob2ZmZXI6IFNhbGVzT2ZmZXIsIGV4Y2x1c2l2ZVZhdD86IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIGNvbnN0IGFsbFNlbGVjdGVkUHJvZHVjdE9wdGlvbnMgPSBTYWxlc09mZmVyVXRpbC5nZXRBbGxTZWxlY3RlZFByb2R1Y3RPcHRpb25zKG9mZmVyKTtcbiAgICByZXR1cm4gKFxuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByaWNlRm9ySXRlbXMoYWxsU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucywgISFleGNsdXNpdmVWYXQpICtcbiAgICAgIFNhbGVzT2ZmZXJVdGlsLmdldE1vbnRobHlQZXJtYW5lbnRQcm9tb0Rpc2NvdW50Rm9ySXRlbXMoYWxsU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucywgISFleGNsdXNpdmVWYXQpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0TW9udGhseVByaWNlRm9yUHJvZHVjdHMob2ZmZXI6IFNhbGVzT2ZmZXIsIGV4Y2x1c2l2ZVZhdD86IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIHJldHVybiAoXG4gICAgICBTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJpY2VGb3JJdGVtcyhvZmZlci5wcm9kdWN0cywgISFleGNsdXNpdmVWYXQpICtcbiAgICAgIFNhbGVzT2ZmZXJVdGlsLmdldE1vbnRobHlQZXJtYW5lbnRQcm9tb0Rpc2NvdW50Rm9ySXRlbXMob2ZmZXIucHJvZHVjdHMsICEhZXhjbHVzaXZlVmF0KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldE1vbnRobHlQcmljZUZvclN0YW5kYWxvbmVPcHRpb25zKG9mZmVyOiBTYWxlc09mZmVyLCBleGNsdXNpdmVWYXQ/OiBib29sZWFuKTogbnVtYmVyIHtcbiAgICByZXR1cm4gKFxuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByaWNlRm9ySXRlbXMob2ZmZXIuc3RhbmRhbG9uZW9wdGlvbnMsICEhZXhjbHVzaXZlVmF0KSArXG4gICAgICBTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UGVybWFuZW50UHJvbW9EaXNjb3VudEZvckl0ZW1zKG9mZmVyLnN0YW5kYWxvbmVvcHRpb25zLCAhIWV4Y2x1c2l2ZVZhdClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRNb250aGx5UHJvbW9zRm9yU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucyhvZmZlcjogU2FsZXNPZmZlciwgZXhjbHVzaXZlVmF0PzogYm9vbGVhbik6IG51bWJlciB7XG4gICAgcmV0dXJuIHN1bShcbiAgICAgIG1hcChcbiAgICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vdGlvbnMoU2FsZXNPZmZlclV0aWwuZ2V0QWxsU2VsZWN0ZWRQcm9kdWN0T3B0aW9ucyhvZmZlcikpLFxuICAgICAgICAocDogU2FsZXNPZmZlclByb21vKSA9PiAoZXhjbHVzaXZlVmF0ID8gcC5wcmljZWV4Y2x2YXQgOiBwLnByaWNlKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldE1vbnRobHlQcm9tb3NGb3JQcm9kdWN0cyhvZmZlcjogU2FsZXNPZmZlciwgZXhjbHVzaXZlVmF0PzogYm9vbGVhbik6IG51bWJlciB7XG4gICAgcmV0dXJuIHN1bShcbiAgICAgIG1hcChTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJvbW90aW9ucyhvZmZlci5wcm9kdWN0cyksIChwOiBTYWxlc09mZmVyUHJvbW8pID0+XG4gICAgICAgIGV4Y2x1c2l2ZVZhdCA/IHAucHJpY2VleGNsdmF0IDogcC5wcmljZVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldE1vbnRobHlQcm9tb3NGb3JTdGFuZGFsb25lT3B0aW9ucyhvZmZlcjogU2FsZXNPZmZlciwgZXhjbHVzaXZlVmF0PzogYm9vbGVhbik6IG51bWJlciB7XG4gICAgcmV0dXJuIHN1bShcbiAgICAgIG1hcChTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJvbW90aW9ucyhvZmZlci5zdGFuZGFsb25lb3B0aW9ucyksIChwOiBTYWxlc09mZmVyUHJvbW8pID0+XG4gICAgICAgIGV4Y2x1c2l2ZVZhdCA/IHAucHJpY2VleGNsdmF0IDogcC5wcmljZVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldE1vbnRobHlQcm9tb3Mob2ZmZXI6IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvbW9bXSB7XG4gICAgcmV0dXJuIGZsYXRNYXAob2ZmZXIucHJvZHVjdHMsIChwcm9kdWN0KSA9PiBTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJvZHVjdFByb21vcyhwcm9kdWN0KSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEFsbFByb21vcyhvZmZlcjogU2FsZXNPZmZlcik6IFNhbGVzT2ZmZXJQcm9tb1tdIHtcbiAgICByZXR1cm4gY29uY2F0KFxuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vcyhvZmZlciksXG4gICAgICBmbGF0TWFwKG9mZmVyLnByb2R1Y3RzLCAocHJvZHVjdCkgPT4gU2FsZXNPZmZlclV0aWwuZ2V0Q29zdFByb21vcyhwcm9kdWN0KSksXG4gICAgICBmbGF0TWFwKG9mZmVyLnByb2R1Y3RzLCAocHJvZHVjdCkgPT4gU2FsZXNPZmZlclV0aWwuZ2V0SW5zdGFsbFByb21vcyhwcm9kdWN0KSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmaW5kUHJvZHVjdChvZmZlcjogU2FsZXNPZmZlciwgb21hcGlJZDogc3RyaW5nKTogU2FsZXNPZmZlclByb2R1Y3QgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiBvZmZlciAmJiBvZmZlci5wcm9kdWN0cyA/IG9mZmVyLnByb2R1Y3RzLmZpbmQoKHByb2R1Y3QpID0+IHByb2R1Y3Qub21hcGlpZCA9PT0gb21hcGlJZCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRDb3N0UHJvbW9zKHByb2R1Y3Q6IFNhbGVzT2ZmZXJQcm9kdWN0KTogU2FsZXNPZmZlclByb21vW10ge1xuICAgIHJldHVybiBmbGF0TWFwKHByb2R1Y3QuY29zdHMsIChjb3N0KSA9PiBjb3N0LnByb21vdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0SW5zdGFsbFByb21vcyhwcm9kdWN0OiBTYWxlc09mZmVyUHJvZHVjdCk6IFNhbGVzT2ZmZXJQcm9tb1tdIHtcbiAgICByZXR1cm4gZmxhdE1hcChcbiAgICAgIHByb2R1Y3QuaW5zdGFsbHR5cGVzLmZpbHRlcigoaW5zdGFsbFR5cGUpID0+IGluc3RhbGxUeXBlLnNlbGVjdGVkKSxcbiAgICAgIChpbnN0YWxsVHlwZSkgPT4gaW5zdGFsbFR5cGUucHJvbW9zXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldE1vbnRobHlQcm9kdWN0UHJvbW9zKHByb2R1Y3Q6IFNhbGVzT2ZmZXJQcm9kdWN0KTogU2FsZXNPZmZlclByb21vW10ge1xuICAgIHJldHVybiBjb25jYXQoXG4gICAgICBwcm9kdWN0LnByb21vcyxcbiAgICAgIGZsYXRNYXAocHJvZHVjdC5vcHRpbnByb2R1Y3RzLCAob3B0aW4pID0+IG9wdGluLnByb21vcyksXG4gICAgICBmbGF0TWFwKFxuICAgICAgICBwcm9kdWN0Lm9wdGlvbnMuZmlsdGVyKChvcHRpb24pID0+IG9wdGlvbi5zZWxlY3RlZCksXG4gICAgICAgIChvcHRpb24pID0+IG9wdGlvbi5wcm9tb3NcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRNb250aGx5UHJvbW9zR3JvdXBlZEJ5RHVyYXRpb24ob2ZmZXI6IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvbW9EdXJhdGlvbkdyb3VwW10ge1xuICAgIHJldHVybiBtYXAoXG4gICAgICBncm91cEJ5KFxuICAgICAgICBTYWxlc09mZmVyVXRpbC5nZXRNb250aGx5UHJvbW9zKG9mZmVyKS5maWx0ZXIoKHByb21vKSA9PiBwcm9tby5kdXJhdGlvbiA+IDApLFxuICAgICAgICAocHJvbW86IFNhbGVzT2ZmZXJQcm9tbykgPT4gcHJvbW8uZHVyYXRpb25cbiAgICAgICksXG4gICAgICAocHJvbW9zOiBTYWxlc09mZmVyUHJvbW9bXSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBkdXJhdGlvbjogTnVtYmVyKGtleSksXG4gICAgICAgICAgcHJvbW9zOiBwcm9tb3MsXG4gICAgICAgIH0gYXMgU2FsZXNPZmZlclByb21vRHVyYXRpb25Hcm91cDtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRQcm9tb0R1cmF0aW9uR3JvdXBzVG90YWwoXG4gICAgc2FsZXNPZmZlclByb21vR3JvdXBzOiBTYWxlc09mZmVyUHJvbW9EdXJhdGlvbkdyb3VwW10sXG4gICAgZXhjbHVzaXZlVmF0PzogYm9vbGVhblxuICApOiBudW1iZXIge1xuICAgIHJldHVybiBzdW0oXG4gICAgICBtYXAoXG4gICAgICAgIGZsYXRNYXAoc2FsZXNPZmZlclByb21vR3JvdXBzLCAoZ3JvdXA6IFNhbGVzT2ZmZXJQcm9tb0R1cmF0aW9uR3JvdXApID0+IGdyb3VwLnByb21vcyksXG4gICAgICAgIChwcm9tbzogU2FsZXNPZmZlclByb21vKSA9PiAoZXhjbHVzaXZlVmF0ID8gcHJvbW8ucHJpY2VleGNsdmF0IDogcHJvbW8ucHJpY2UpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0QnVuZGxlKG9mZmVyOiBTYWxlc09mZmVyKTogU2FsZXNPZmZlclByb2R1Y3Qge1xuICAgIGNvbnN0IGJ1bmRsZSA9IG9mZmVyLnByb2R1Y3RzLmZpbmQoKHByb2R1Y3QpID0+IHtcbiAgICAgIHJldHVybiBwcm9kdWN0LnByb2R1Y3RJbmZvICYmIHByb2R1Y3QucHJvZHVjdEluZm8uaXNCdW5kbGUoKTtcbiAgICB9KTtcblxuICAgIGlmICghYnVuZGxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NhbGVzb2ZmZXIgZG9lcyBub3QgY29udGFpbiBhIGJ1bmRsZScpO1xuICAgIH1cblxuICAgIHJldHVybiBidW5kbGU7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGNvbnRhaW5zUmVzaWRlbnRpYWxQcm9kdWN0KG9mZmVyOiBTYWxlc09mZmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9mZmVyLnByb2R1Y3RzLnNvbWUoKHByb2R1Y3QpID0+IFNhbGVzT2ZmZXJQcm9kdWN0VXRpbC5pc1Jlc2lkZW50aWFsUHJvZHVjdChwcm9kdWN0KSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGNvbnRhaW5zU29ob1Byb2R1Y3Qob2ZmZXI6IFNhbGVzT2ZmZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb2ZmZXIucHJvZHVjdHMuc29tZSgocHJvZHVjdCkgPT4gU2FsZXNPZmZlclByb2R1Y3RVdGlsLmlzU29ob1Byb2R1Y3QocHJvZHVjdCkpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjb250YWluc1Byb21vVGFnKG9mZmVyOiBTYWxlc09mZmVyUHJvZHVjdCwgdGFnOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gU2FsZXNPZmZlclByb21vVXRpbC5jb250YWluc1RhZyhvZmZlci5wcm9tb3MsIHRhZyk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRNb250aGx5UHJpY2VGb3JJdGVtcyhpdGVtczogU2FsZXNPZmZlclByaWNlZEl0ZW1bXSwgZXhjbHVzaXZlVmF0OiBib29sZWFuKTogbnVtYmVyIHtcbiAgICByZXR1cm4gc3VtKG1hcChpdGVtcywgKHApID0+IChleGNsdXNpdmVWYXQgPyBwLnByaWNlZXhjbHZhdCA6IHAucHJpY2UpKSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRNb250aGx5UGVybWFuZW50UHJvbW9EaXNjb3VudEZvckl0ZW1zKFxuICAgIGl0ZW1zOiBTYWxlc09mZmVyUHJvZHVjdFtdIHwgU2FsZXNPZmZlclByb2R1Y3RPcHRpb25bXSxcbiAgICBleGNsdXNpdmVWYXQ6IGJvb2xlYW5cbiAgKTogbnVtYmVyIHtcbiAgICByZXR1cm4gU2FsZXNPZmZlclV0aWwuZ2V0UGVybWFuZW50UHJvbW90aW9ucyhpdGVtcylcbiAgICAgIC5tYXAoKHByb21vKSA9PiBTYWxlc09mZmVyVXRpbC5nZXRQcmljZShwcm9tbywgZXhjbHVzaXZlVmF0KSlcbiAgICAgIC5yZWR1Y2UoKGN1cnIsIHByZXZpb3VzKSA9PiBjdXJyICsgcHJldmlvdXMsIDApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0UGVybWFuZW50UHJvbW90aW9ucyhpdGVtczogU2FsZXNPZmZlclByb2R1Y3RbXSB8IFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW9uW10pOiBTYWxlc09mZmVyUHJvbW9bXSB7XG4gICAgcmV0dXJuIFNhbGVzT2ZmZXJVdGlsLmdldFByb21vdGlvbnNXaXRoRHVyYXRpb24oaXRlbXMsIChwcm9tbzogU2FsZXNPZmZlclByb21vKTogYm9vbGVhbiA9PiBwcm9tbz8uZHVyYXRpb24gPT09IDApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0TW9udGhseVByb21vdGlvbnMoaXRlbXM6IFNhbGVzT2ZmZXJQcm9kdWN0W10gfCBTYWxlc09mZmVyUHJvZHVjdE9wdGlvbltdKTogU2FsZXNPZmZlclByb21vW10ge1xuICAgIHJldHVybiBTYWxlc09mZmVyVXRpbC5nZXRQcm9tb3Rpb25zV2l0aER1cmF0aW9uKGl0ZW1zLCAocHJvbW86IFNhbGVzT2ZmZXJQcm9tbyk6IGJvb2xlYW4gPT4gcHJvbW8/LmR1cmF0aW9uID4gMCk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRQcm9tb3Rpb25zV2l0aER1cmF0aW9uKFxuICAgIGl0ZW1zOiBTYWxlc09mZmVyUHJvZHVjdFtdIHwgU2FsZXNPZmZlclByb2R1Y3RPcHRpb25bXSxcbiAgICBkdXJhdGlvbkZpbHRlcjogKHByb21vOiBTYWxlc09mZmVyUHJvbW8pID0+IGJvb2xlYW5cbiAgKTogU2FsZXNPZmZlclByb21vW10ge1xuICAgIHJldHVybiAoaXRlbXMgfHwgW10pXG4gICAgICAubWFwKChpdGVtOiBTYWxlc09mZmVyUHJvZHVjdE9wdGlvbiB8IFNhbGVzT2ZmZXJQcm9kdWN0KSA9PiBpdGVtLnByb21vcylcbiAgICAgIC5yZWR1Y2UoKGFjY3VtdWxhdG9yLCB2YWx1ZSkgPT4gYWNjdW11bGF0b3IuY29uY2F0KHZhbHVlKSwgW10pXG4gICAgICAuZmlsdGVyKGR1cmF0aW9uRmlsdGVyKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0U2hvcnRlc3REdXJhdGlvbk9mQWxsUHJvbW9zKHNhbGVzT2ZmZXI6IFNhbGVzT2ZmZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBtaW4oW1xuICAgICAgdGhpcy5nZXRTaG9ydGVzdFByb21vRHVyYXRpb25PZlByb2R1Y3RzKHNhbGVzT2ZmZXIpLFxuICAgICAgdGhpcy5nZXRTaG9ydGVzdFByb21vRHVyYXRpb25PZlByb2R1Y3RPcHRpb25zKHNhbGVzT2ZmZXIpLFxuICAgICAgdGhpcy5nZXRTaG9ydGVzdFByb21vRHVyYXRpb25PZlN0YW5kYWxvbmVPcHRpb25zKHNhbGVzT2ZmZXIpLFxuICAgIF0pIGFzIG51bWJlcjtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0UHJpY2VJbmNsUHJvbW8oXG4gICAgc2FsZXNPZmZlclByb2R1Y3Q6IFNhbGVzT2ZmZXJQcm9kdWN0IHwgU2FsZXNPZmZlclByb2R1Y3RPcHRpb24gfCBTYWxlc09mZmVyUHJvZHVjdE9wdGluLFxuICAgIGJ1c2luZXNzOiBib29sZWFuXG4gICk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UHJpY2Uoc2FsZXNPZmZlclByb2R1Y3QsIGJ1c2luZXNzKSArIHN1bUJ5KHNhbGVzT2ZmZXJQcm9kdWN0LnByb21vcywgdGhpcy5nZXRQcmljZVRhZyhidXNpbmVzcykpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRUb3RhbFRlbXBvcmFyeURpc2NvdW50KHNhbGVzT2ZmZXJQcm9kdWN0OiBTYWxlc09mZmVyUHJvZHVjdCwgYnVzaW5lc3M6IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIGNvbnN0IHRlbXBvcmFyeVByb21vcyA9IHNhbGVzT2ZmZXJQcm9kdWN0LnByb21vcy5maWx0ZXIoKHByb21vKSA9PiBwcm9tby5kdXJhdGlvbiAhPT0gMCk7XG4gICAgcmV0dXJuIHN1bUJ5KHRlbXBvcmFyeVByb21vcywgdGhpcy5nZXRQcmljZVRhZyhidXNpbmVzcykpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRTaG9ydGVzdFByb21vRHVyYXRpb24oXG4gICAgc2FsZXNPZmZlclByb2R1Y3Q6IFNhbGVzT2ZmZXJQcm9kdWN0IHwgU2FsZXNPZmZlclByb2R1Y3RPcHRpb24gfCBTYWxlc09mZmVyUHJvZHVjdE9wdGluXG4gICk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY2FsY3VsYXRlU2hvcnRlc3RQcm9tb0R1cmF0aW9uKHNhbGVzT2ZmZXJQcm9kdWN0LnByb21vcyk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRUb3RhbE1vbnRobHlQcm9tb1ByaWNlKG9mZmVyOiBTYWxlc09mZmVyLCBleGNsdXNpdmVWYXQ/OiBib29sZWFuKTogbnVtYmVyIHtcbiAgICByZXR1cm4gc3VtKFtcbiAgICAgIFNhbGVzT2ZmZXJVdGlsLmdldE1vbnRobHlQcm9tb3NGb3JQcm9kdWN0cyhvZmZlciwgZXhjbHVzaXZlVmF0KSxcbiAgICAgIFNhbGVzT2ZmZXJVdGlsLmdldE1vbnRobHlQcm9tb3NGb3JTZWxlY3RlZFByb2R1Y3RPcHRpb25zKG9mZmVyLCBleGNsdXNpdmVWYXQpLFxuICAgICAgU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vc0ZvclN0YW5kYWxvbmVPcHRpb25zKG9mZmVyLCBleGNsdXNpdmVWYXQpLFxuICAgIF0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRQcmljZShcbiAgICBzYWxlc09mZmVyUHJvZHVjdDogU2FsZXNPZmZlclByb2R1Y3QgfCBTYWxlc09mZmVyUHJvZHVjdE9wdGlvbiB8IFNhbGVzT2ZmZXJQcm9kdWN0T3B0aW4gfCBTYWxlc09mZmVyUHJvbW8sXG4gICAgYnVzaW5lc3M6IGJvb2xlYW5cbiAgKTogbnVtYmVyIHtcbiAgICByZXR1cm4gYnVzaW5lc3MgPyBzYWxlc09mZmVyUHJvZHVjdC5wcmljZWV4Y2x2YXQgOiBzYWxlc09mZmVyUHJvZHVjdC5wcmljZTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFByaWNlVGFnKGJ1c2luZXNzOiBib29sZWFuKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYnVzaW5lc3MgPyAncHJpY2VleGNsdmF0JyA6ICdwcmljZSc7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBjYWxjdWxhdGVTaG9ydGVzdFByb21vRHVyYXRpb24oc2FsZXNPZmZlclByb21vczogU2FsZXNPZmZlclByb21vW10pOiBudW1iZXIge1xuICAgIGNvbnN0IHNob3J0ZXN0RHVyYXRpb25Qcm9tbyA9IG1pbkJ5KHNhbGVzT2ZmZXJQcm9tb3MsICdkdXJhdGlvbicpO1xuXG4gICAgcmV0dXJuICFpc1VuZGVmaW5lZChzaG9ydGVzdER1cmF0aW9uUHJvbW8pID8gc2hvcnRlc3REdXJhdGlvblByb21vLmR1cmF0aW9uIDogMDtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFNob3J0ZXN0UHJvbW9EdXJhdGlvbk9mUHJvZHVjdHMoc2FsZXNPZmZlcjogU2FsZXNPZmZlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIG1pbihtYXAoU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vdGlvbnMoc2FsZXNPZmZlci5wcm9kdWN0cyksIChwcm9tbykgPT4gcHJvbW8uZHVyYXRpb24pKSBhcyBudW1iZXI7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRTaG9ydGVzdFByb21vRHVyYXRpb25PZlN0YW5kYWxvbmVPcHRpb25zKHNhbGVzT2ZmZXI6IFNhbGVzT2ZmZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBtaW4oXG4gICAgICBtYXAoU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vdGlvbnMoc2FsZXNPZmZlci5zdGFuZGFsb25lb3B0aW9ucyksIChwcm9tbykgPT4gcHJvbW8uZHVyYXRpb24pXG4gICAgKSBhcyBudW1iZXI7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRTaG9ydGVzdFByb21vRHVyYXRpb25PZlByb2R1Y3RPcHRpb25zKHNhbGVzT2ZmZXI6IFNhbGVzT2ZmZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBtaW4oXG4gICAgICBtYXAoU2FsZXNPZmZlclV0aWwuZ2V0TW9udGhseVByb21vdGlvbnModGhpcy5nZXRBbGxTZWxlY3RlZFByb2R1Y3RPcHRpb25zKHNhbGVzT2ZmZXIpKSwgKHByb21vKSA9PiBwcm9tby5kdXJhdGlvbilcbiAgICApIGFzIG51bWJlcjtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0Q29zdHMoc2FsZXNPZmZlcjogU2FsZXNPZmZlciwgbmFtZUZpbHRlcjogc3RyaW5nIHwgbnVsbCA9IG51bGwpOiBTYWxlc09mZmVyQ29zdFtdIHtcbiAgICBjb25zdCBmbGF0ID0gKHNvbWVGdW5jdGlvbjogKHByb2R1Y3Q6IFNhbGVzT2ZmZXJQcm9kdWN0KSA9PiBTYWxlc09mZmVyQ29zdFtdLCBhcnI6IFNhbGVzT2ZmZXJQcm9kdWN0W10pID0+XG4gICAgICBhcnIucmVkdWNlKFxuICAgICAgICAoc2FsZXNPZmZlckNvc3RzOiBTYWxlc09mZmVyQ29zdFtdLCBzYWxlc09mZmVyUHJvZHVjdDogU2FsZXNPZmZlclByb2R1Y3QpID0+IFtcbiAgICAgICAgICAuLi5zYWxlc09mZmVyQ29zdHMsXG4gICAgICAgICAgLi4uc29tZUZ1bmN0aW9uKHNhbGVzT2ZmZXJQcm9kdWN0KSxcbiAgICAgICAgXSxcbiAgICAgICAgW11cbiAgICAgICk7XG4gICAgY29uc3QgY29zdHMgPSBmbGF0KChwcm9kdWN0OiBTYWxlc09mZmVyUHJvZHVjdCkgPT4ge1xuICAgICAgaWYgKHByb2R1Y3QuY29zdHMpIHtcbiAgICAgICAgcmV0dXJuIHByb2R1Y3QuY29zdHM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG4gICAgfSwgc2FsZXNPZmZlci5wcm9kdWN0cyk7XG4gICAgaWYgKG5hbWVGaWx0ZXIpIHtcbiAgICAgIHJldHVybiBjb3N0cy5maWx0ZXIoKGNvc3QpID0+IGNvc3QubmFtZSA9PT0gbmFtZUZpbHRlcik7XG4gICAgfVxuICAgIHJldHVybiBjb3N0cztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFsbFR5cGVzKHNhbGVzT2ZmZXI6IFNhbGVzT2ZmZXIpOiBTYWxlc09mZmVyUHJvZHVjdEluc3RhbGxUeXBlW10ge1xuICAgIHJldHVybiBmbGF0TWFwKHNhbGVzT2ZmZXIucHJvZHVjdHMsIChwcm9kdWN0KSA9PiBwcm9kdWN0Lmluc3RhbGx0eXBlcyk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzT3JkZXJpbmdIaWdoVGllcihzYWxlc09mZmVyOiBTYWxlc09mZmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHNhbGVzT2ZmZXIucHJvZHVjdHMuc29tZSgocHJvZHVjdCkgPT4ge1xuICAgICAgcmV0dXJuIHByb2R1Y3QucHJvZHVjdEluZm8gJiYgcHJvZHVjdC5wcm9kdWN0SW5mby5pc0hpZ2hUaWVyKCk7XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgY29udGFpbnNBbGwob2ZmZXI6IFNhbGVzT2ZmZXIsIG9tYXBpSWRzOiBzdHJpbmdbXSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvbWFwaUlkcy5ldmVyeSgob21hcGlJZCkgPT4gdGhpcy5jb250YWlucyhvZmZlciwgb21hcGlJZCkpO1xuICB9XG5cbiAgc3RhdGljIGNvbnRhaW5zQW55KG9mZmVyOiBTYWxlc09mZmVyLCBvbWFwaUlkczogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICByZXR1cm4gb21hcGlJZHMuc29tZSgob21hcGlJZCkgPT4gdGhpcy5jb250YWlucyhvZmZlciwgb21hcGlJZCkpO1xuICB9XG5cbiAgc3RhdGljIGNvbnRhaW5zKG9mZmVyOiBTYWxlc09mZmVyLCBvbWFwaUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb2ZmZXIucHJvZHVjdHMuc29tZSgocHJvZHVjdCkgPT4gcHJvZHVjdC5vbWFwaWlkID09PSBvbWFwaUlkKTtcbiAgfVxufVxuIl19