import { inject, Injectable } from '@angular/core';
import { catchError, finalize, map, shareReplay, take } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import { of, ReplaySubject, throwError } from 'rxjs';
import { ErrorMessage, MessageService } from '@telenet/ng-lib-message';
import { LoginDetails, OcapiCallConfig } from '../models';
import { LoginDetailsMapper } from '../mappers';
import { ConfigConstants, ConfigService } from '@telenet/ng-lib-config';
import { OcapiHelper } from '../utils';
import { ErrorReportService } from './error-report.service';
import { QueryParamEnum, UrlService } from '@telenet/ng-lib-page';
import { LogFactory } from '@telenet/ng-lib-shared';
import * as i0 from "@angular/core";
export class UserDetailsService {
    static LOG = LogFactory.createLogger(UserDetailsService);
    endpoint = '/oauth/userdetails';
    cache = new Map();
    loginDetailsMapper = inject(LoginDetailsMapper);
    messageService = inject(MessageService);
    ocapiHelper = inject(OcapiHelper);
    configService = inject(ConfigService);
    http = inject(HttpClient);
    errorReportService = inject(ErrorReportService);
    urlService = inject(UrlService);
    reset() {
        this.cache.clear();
    }
    getUserDetails(options = {}) {
        const { withCredentials = true, referrerUrl, jwtToken } = options;
        let endpointWithParameters = this.endpoint;
        const jwt = jwtToken ? jwtToken : this.extractJwtFromUrl();
        if (jwt) {
            endpointWithParameters = `${endpointWithParameters}?jwt=${jwt}`;
        }
        const ocapiConfig = new OcapiCallConfig('', endpointWithParameters, this.loginDetailsMapper);
        ocapiConfig.withCredentials = withCredentials;
        ocapiConfig.authNeeded = false;
        if (referrerUrl && referrerUrl.length > 0) {
            ocapiConfig.customHeaders = { ...(ocapiConfig.customHeaders || {}), 'x-alt-referer': referrerUrl };
        }
        return this.getUserDetailsForConfig(ocapiConfig).pipe(shareReplay({ bufferSize: 1, refCount: false }), catchError((error) => {
            if (error.status !== 401) {
                return throwError(() => error);
            }
            const { status, error: errorMessage } = error;
            const [state, nonce] = String(errorMessage).split(',');
            const loginDetails = new LoginDetails(status);
            loginDetails.state = state;
            loginDetails.nonce = nonce;
            return of(loginDetails);
        }));
    }
    extractJwtFromUrl() {
        const jwtToken = this.urlService.getRequestParamValue(QueryParamEnum.JWT_TOKEN, '');
        return jwtToken ? jwtToken : this.urlService.getHashParameter(QueryParamEnum.JWT_TOKEN);
    }
    createHashKey(ocapiCall) {
        const { errorHandler: _, endpoint: __, ...otherProps } = ocapiCall;
        return btoa(JSON.stringify(otherProps));
    }
    hasJwtParameter(endpoint) {
        return !!endpoint && endpoint.includes('jwt');
    }
    getUserDetailsForConfig(config) {
        const cacheKey = this.createHashKey(config);
        if (!this.hasJwtParameter(config.endpoint) && this.cache.has(cacheKey)) {
            const replaySubject$ = this.cache.get(cacheKey);
            if (replaySubject$) {
                return replaySubject$.asObservable();
            }
        }
        return this.getCacheableUserDetailsObservable(cacheKey, config);
    }
    getCacheableUserDetailsObservable(cacheKey, config) {
        const freshReplaySubject$ = new ReplaySubject(1);
        this.cache.set(cacheKey, freshReplaySubject$);
        this.doResolve(config)
            .pipe(take(1), finalize(() => {
            freshReplaySubject$.complete();
        }))
            .subscribe({
            next: (loginDetails) => {
                if (loginDetails instanceof LoginDetails) {
                    freshReplaySubject$.next(loginDetails);
                }
            },
            error: (error) => freshReplaySubject$.error(error),
        });
        return freshReplaySubject$.asObservable();
    }
    handleError(ocapiCallConfig) {
        return (error) => {
            if (error.status !== 401) {
                this.messageService.addMessage(new ErrorMessage(ocapiCallConfig.messageGroupName, 'ocapi.' + error.status));
                UserDetailsService.LOG.logDebug(`An error occurred while trying to fetch ${ocapiCallConfig.messageGroupName}`, error);
                return throwError(() => 'An error occured while trying to fetch ' + ocapiCallConfig.messageGroupName);
            }
            return throwError(() => error);
        };
    }
    doResolve(ocapiCallConfig) {
        try {
            const options = this.getHttpOptions(ocapiCallConfig);
            return this.http
                .get(this.configService.getConfig(ConfigConstants.OCAPI_URl) + ocapiCallConfig.getEndpoint(), options)
                .pipe(map((ocapiResponse) => {
                return ocapiCallConfig.mapper?.toModel(ocapiResponse) || ocapiResponse;
            }), catchError(this.handleError(ocapiCallConfig)));
        }
        catch (e) {
            this.errorReportService.sendErrorEventToAnalytics(ocapiCallConfig);
            this.messageService.addMessage(new ErrorMessage(ocapiCallConfig.messageGroupName, 'Ocapi call failed:' + ocapiCallConfig.endpoint + 'with data ' + JSON.stringify(ocapiCallConfig.data)));
            return throwError(() => new Error('An error occured while trying to fetch ' + ocapiCallConfig.endpoint));
        }
    }
    getHttpOptions(ocapiConfig) {
        const httpOptions = {
            withCredentials: ocapiConfig.withCredentials,
            headers: this.ocapiHelper.getHttpHeaders(ocapiConfig),
            responseType: 'json',
        };
        return httpOptions;
    }
    static ɵfac = function UserDetailsService_Factory(t) { return new (t || UserDetailsService)(); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: UserDetailsService, factory: UserDetailsService.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(UserDetailsService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], null, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1kZXRhaWxzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL3NlcnZpY2VzL3VzZXItZGV0YWlscy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUUsT0FBTyxFQUFFLFVBQVUsRUFBMkQsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRyxPQUFPLEVBQWMsRUFBRSxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakUsT0FBTyxFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDaEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN4RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEUsT0FBTyxFQUFPLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFDOztBQWdCekQsTUFBTSxPQUFPLGtCQUFrQjtJQUNyQixNQUFNLENBQVUsR0FBRyxHQUFRLFVBQVUsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUU5RCxRQUFRLEdBQUcsb0JBQW9CLENBQUM7SUFFaEMsS0FBSyxH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LENBQUMsV0FBVyxDQUFDO1lBQ3JELFlBQVksRUFBRSxNQUFNO1NBQ3JCLENBQUM7UUFFRixPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOzRFQS9KVSxrQkFBa0I7Z0VBQWxCLGtCQUFrQixXQUFsQixrQkFBa0IsbUJBRmpCLE1BQU07O2lGQUVQLGtCQUFrQjtjQUg5QixVQUFVO2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGZpbmFsaXplLCBtYXAsIHNoYXJlUmVwbGF5LCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cENvbnRleHQsIEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwSGVhZGVycywgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBSZXBsYXlTdWJqZWN0LCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFcnJvck1lc3NhZ2UsIE1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnQHRlbGVuZXQvbmctbGliLW1lc3NhZ2UnO1xuaW1wb3J0IHsgTG9naW5EZXRhaWxzLCBPY2FwaUNhbGxDb25maWcgfSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgTG9naW5EZXRhaWxzTWFwcGVyIH0gZnJvbSAnLi4vbWFwcGVycyc7XG5pbXBvcnQgeyBDb25maWdDb25zdGFudHMsIENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAdGVsZW5ldC9uZy1saWItY29uZmlnJztcbmltcG9ydCB7IE9jYXBpSGVscGVyIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgRXJyb3JSZXBvcnRTZXJ2aWNlIH0gZnJvbSAnLi9lcnJvci1yZXBvcnQuc2VydmljZSc7XG5pbXBvcnQgeyBRdWVyeVBhcmFtRW51bSwgVXJsU2VydmljZSB9IGZyb20gJ0B0ZWxlbmV0L25nLWxpYi1wYWdlJztcbmltcG9ydCB7IExvZywgTG9nRmFjdG9yeSB9IGZyb20gJ0B0ZWxlbmV0L25nLWxpYi1zaGFyZWQnO1xuXG5pbnRlcmZhY2UgVXNlckRldGFpbHNPcHRpb25zIHtcbiAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgand0VG9rZW4/OiBzdHJpbmc7XG4gIHJlZmVycmVyVXJsPzogc3RyaW5nO1xuICBlcnJvckhhbmRsZXI/OiAoXG4gICAgZXJyb3JIYW5kbGVyOiBIdHRwRXJyb3JSZXNwb25zZSxcbiAgICBjb25maWc6IE9jYXBpQ2FsbENvbmZpZzxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgTG9naW5EZXRhaWxzPlxuICApID0+IE9ic2VydmFibGU8dW5rbm93bj47XG4gIGZvcmNlVXBkYXRlPzogYm9vbGVhbjtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJEZXRhaWxzU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IExPRzogTG9nID0gTG9nRmFjdG9yeS5jcmVhdGVMb2dnZXIoVXNlckRldGFpbHNTZXJ2aWNlKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGVuZHBvaW50ID0gJy9vYXV0aC91c2VyZGV0YWlscyc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjYWNoZTogTWFwPHN0cmluZywgUmVwbGF5U3ViamVjdDxMb2dpbkRldGFpbHM+PiA9IG5ldyBNYXA8c3RyaW5nLCBSZXBsYXlTdWJqZWN0PExvZ2luRGV0YWlscz4+KCk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dpbkRldGFpbHNNYXBwZXI6IExvZ2luRGV0YWlsc01hcHBlciA9IGluamVjdChMb2dpbkRldGFpbHNNYXBwZXIpO1xuICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2VTZXJ2aWNlOiBNZXNzYWdlU2VydmljZSA9IGluamVjdChNZXNzYWdlU2VydmljZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgb2NhcGlIZWxwZXI6IE9jYXBpSGVscGVyID0gaW5qZWN0KE9jYXBpSGVscGVyKTtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlID0gaW5qZWN0KENvbmZpZ1NlcnZpY2UpO1xuICBwcml2YXRlIHJlYWRvbmx5IGh0dHAgPSBpbmplY3QoSHR0cENsaWVudCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXJyb3JSZXBvcnRTZXJ2aWNlID0gaW5qZWN0KEVycm9yUmVwb3J0U2VydmljZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgdXJsU2VydmljZSA9IGluamVjdChVcmxTZXJ2aWNlKTtcblxuICByZXNldCgpIHtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gIH1cblxuICBnZXRVc2VyRGV0YWlscyhvcHRpb25zOiBVc2VyRGV0YWlsc09wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHsgd2l0aENyZWRlbnRpYWxzID0gdHJ1ZSwgcmVmZXJyZXJVcmwsIGp3dFRva2VuIH0gPSBvcHRpb25zO1xuXG4gICAgbGV0IGVuZHBvaW50V2l0aFBhcmFtZXRlcnMgPSB0aGlzLmVuZHBvaW50O1xuICAgIGNvbnN0IGp3dCA9IGp3dFRva2VuID8gand0VG9rZW4gOiB0aGlzLmV4dHJhY3RKd3RGcm9tVXJsKCk7XG5cbiAgICBpZiAoand0KSB7XG4gICAgICBlbmRwb2ludFdpdGhQYXJhbWV0ZXJzID0gYCR7ZW5kcG9pbnRXaXRoUGFyYW1ldGVyc30/and0PSR7and0fWA7XG4gICAgfVxuICAgIGNvbnN0IG9jYXBpQ29uZmlnID0gbmV3IE9jYXBpQ2FsbENvbmZpZygnJywgZW5kcG9pbnRXaXRoUGFyYW1ldGVycywgdGhpcy5sb2dpbkRldGFpbHNNYXBwZXIpO1xuICAgIG9jYXBpQ29uZmlnLndpdGhDcmVkZW50aWFscyA9IHdpdGhDcmVkZW50aWFscztcbiAgICBvY2FwaUNvbmZpZy5hdXRoTmVlZGVkID0gZmFsc2U7XG5cbiAgICBpZiAocmVmZXJyZXJVcmwgJiYgcmVmZXJyZXJVcmwubGVuZ3RoID4gMCkge1xuICAgICAgb2NhcGlDb25maWcuY3VzdG9tSGVhZGVycyA9IHsgLi4uKG9jYXBpQ29uZmlnLmN1c3RvbUhlYWRlcnMgfHwge30pLCAneC1hbHQtcmVmZXJlcic6IHJlZmVycmVyVXJsIH07XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldFVzZXJEZXRhaWxzRm9yQ29uZmlnKG9jYXBpQ29uZmlnKS5waXBlKFxuICAgICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogZmFsc2UgfSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKGVycm9yLnN0YXR1cyAhPT0gNDAxKSB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgc3RhdHVzLCBlcnJvcjogZXJyb3JNZXNzYWdlIH0gPSBlcnJvcjtcbiAgICAgICAgY29uc3QgW3N0YXRlLCBub25jZV0gPSBTdHJpbmcoZXJyb3JNZXNzYWdlKS5zcGxpdCgnLCcpO1xuICAgICAgICBjb25zdCBsb2dpbkRldGFpbHMgPSBuZXcgTG9naW5EZXRhaWxzKHN0YXR1cyk7XG4gICAgICAgIGxvZ2luRGV0YWlscy5zdGF0ZSA9IHN0YXRlO1xuICAgICAgICBsb2dpbkRldGFpbHMubm9uY2UgPSBub25jZTtcblxuICAgICAgICByZXR1cm4gb2YobG9naW5EZXRhaWxzKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEp3dEZyb21VcmwoKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3Qgand0VG9rZW4gPSB0aGlzLnVybFNlcnZpY2UuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUXVlcnlQYXJhbUVudW0uSldUX1RPS0VOLCAnJyk7XG4gICAgcmV0dXJuIGp3dFRva2VuID8gand0VG9rZW4gOiB0aGlzLnVybFNlcnZpY2UuZ2V0SGFzaFBhcmFtZXRlcihRdWVyeVBhcmFtRW51bS5KV1RfVE9LRU4pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVIYXNoS2V5KG9jYXBpQ2FsbDogT2NhcGlDYWxsQ29uZmlnPFJlY29yZDxzdHJpbmcsIHVua25vd24+LCBMb2dpbkRldGFpbHM+KSB7XG4gICAgY29uc3QgeyBlcnJvckhhbmRsZXI6IF8sIGVuZHBvaW50OiBfXywgLi4ub3RoZXJQcm9wcyB9ID0gb2NhcGlDYWxsO1xuICAgIHJldHVybiBidG9hKEpTT04uc3RyaW5naWZ5KG90aGVyUHJvcHMpKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzSnd0UGFyYW1ldGVyKGVuZHBvaW50OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gISFlbmRwb2ludCAmJiBlbmRwb2ludC5pbmNsdWRlcygnand0Jyk7XG4gIH1cblxuICBwcml2YXRlIGdldFVzZXJEZXRhaWxzRm9yQ29uZmlnKFxuICAgIGNvbmZpZzogT2NhcGlDYWxsQ29uZmlnPFJlY29yZDxzdHJpbmcsIHVua25vd24+LCBMb2dpbkRldGFpbHM+XG4gICk6IE9ic2VydmFibGU8TG9naW5EZXRhaWxzPiB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSB0aGlzLmNyZWF0ZUhhc2hLZXkoY29uZmlnKTtcblxuICAgIGlmICghdGhpcy5oYXNKd3RQYXJhbWV0ZXIoY29uZmlnLmVuZHBvaW50KSAmJiB0aGlzLmNhY2hlLmhhcyhjYWNoZUtleSkpIHtcbiAgICAgIGNvbnN0IHJlcGxheVN1YmplY3QkID0gdGhpcy5jYWNoZS5nZXQoY2FjaGVLZXkpO1xuICAgICAgaWYgKHJlcGxheVN1YmplY3QkKSB7XG4gICAgICAgIHJldHVybiByZXBsYXlTdWJqZWN0JC5hc09ic2VydmFibGUoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2FjaGVhYmxlVXNlckRldGFpbHNPYnNlcnZhYmxlKGNhY2hlS2V5LCBjb25maWcpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYWNoZWFibGVVc2VyRGV0YWlsc09ic2VydmFibGUoXG4gICAgY2FjaGVLZXk6IHN0cmluZyxcbiAgICBjb25maWc6IE9jYXBpQ2FsbENvbmZpZzxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgTG9naW5EZXRhaWxzPlxuICApIHtcbiAgICBjb25zdCBmcmVzaFJlcGxheVN1YmplY3QkID0gbmV3IFJlcGxheVN1YmplY3Q8TG9naW5EZXRhaWxzPigxKTtcbiAgICB0aGlzLmNhY2hlLnNldChjYWNoZUtleSwgZnJlc2hSZXBsYXlTdWJqZWN0JCk7XG4gICAgdGhpcy5kb1Jlc29sdmUoY29uZmlnKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICBmcmVzaFJlcGxheVN1YmplY3QkLmNvbXBsZXRlKCk7XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKGxvZ2luRGV0YWlsczogTG9naW5EZXRhaWxzIHwgdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChsb2dpbkRldGFpbHMgaW5zdGFuY2VvZiBMb2dpbkRldGFpbHMpIHtcbiAgICAgICAgICAgIGZyZXNoUmVwbGF5U3ViamVjdCQubmV4dChsb2dpbkRldGFpbHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChlcnJvcikgPT4gZnJlc2hSZXBsYXlTdWJqZWN0JC5lcnJvcihlcnJvciksXG4gICAgICB9KTtcbiAgICByZXR1cm4gZnJlc2hSZXBsYXlTdWJqZWN0JC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3Iob2NhcGlDYWxsQ29uZmlnOiB7IG1lc3NhZ2VHcm91cE5hbWU6IHN0cmluZyB9KSB7XG4gICAgcmV0dXJuIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgIGlmIChlcnJvci5zdGF0dXMgIT09IDQwMSkge1xuICAgICAgICB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmFkZE1lc3NhZ2UobmV3IEVycm9yTWVzc2FnZShvY2FwaUNhbGxDb25maWcubWVzc2FnZUdyb3VwTmFtZSwgJ29jYXBpLicgKyBlcnJvci5zdGF0dXMpKTtcbiAgICAgICAgVXNlckRldGFpbHNTZXJ2aWNlLkxPRy5sb2dEZWJ1ZyhcbiAgICAgICAgICBgQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgdHJ5aW5nIHRvIGZldGNoICR7b2NhcGlDYWxsQ29uZmlnLm1lc3NhZ2VHcm91cE5hbWV9YCxcbiAgICAgICAgICBlcnJvclxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiAnQW4gZXJyb3Igb2NjdXJlZCB3aGlsZSB0cnlpbmcgdG8gZmV0Y2ggJyArIG9jYXBpQ2FsbENvbmZpZy5tZXNzYWdlR3JvdXBOYW1lKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IGVycm9yKTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBkb1Jlc29sdmU8TG9naW5EZXRhaWxzPihcbiAgICBvY2FwaUNhbGxDb25maWc6IE9jYXBpQ2FsbENvbmZpZzx1bmtub3duLCBMb2dpbkRldGFpbHM+XG4gICk6IE9ic2VydmFibGU8TG9naW5EZXRhaWxzIHwgdW5rbm93bj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRIdHRwT3B0aW9ucyhvY2FwaUNhbGxDb25maWcpO1xuICAgICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgICAuZ2V0KHRoaXMuY29uZmlnU2VydmljZS5nZXRDb25maWcoQ29uZmlnQ29uc3RhbnRzLk9DQVBJX1VSbCkgKyBvY2FwaUNhbGxDb25maWcuZ2V0RW5kcG9pbnQoKSwgb3B0aW9ucylcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWFwKChvY2FwaVJlc3BvbnNlOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gb2NhcGlDYWxsQ29uZmlnLm1hcHBlcj8udG9Nb2RlbChvY2FwaVJlc3BvbnNlKSB8fCBvY2FwaVJlc3BvbnNlO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVFcnJvcihvY2FwaUNhbGxDb25maWcpKVxuICAgICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZXJyb3JSZXBvcnRTZXJ2aWNlLnNlbmRFcnJvckV2ZW50VG9BbmFseXRpY3Mob2NhcGlDYWxsQ29uZmlnKTtcbiAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2UuYWRkTWVzc2FnZShcbiAgICAgICAgbmV3IEVycm9yTWVzc2FnZShcbiAgICAgICAgICBvY2FwaUNhbGxDb25maWcubWVzc2FnZUdyb3VwTmFtZSxcbiAgICAgICAgICAnT2NhcGkgY2FsbCBmYWlsZWQ6JyArIG9jYXBpQ2FsbENvbmZpZy5lbmRwb2ludCArICd3aXRoIGRhdGEgJyArIEpTT04uc3RyaW5naWZ5KG9jYXBpQ2FsbENvbmZpZy5kYXRhKVxuICAgICAgICApXG4gICAgICApO1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gbmV3IEVycm9yKCdBbiBlcnJvciBvY2N1cmVkIHdoaWxlIHRyeWluZyB0byBmZXRjaCAnICsgb2NhcGlDYWxsQ29uZmlnLmVuZHBvaW50KSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRIdHRwT3B0aW9uczxMb2dpbkRldGFpbHM+KG9jYXBpQ29uZmlnOiBPY2FwaUNhbGxDb25maWc8dW5rbm93biwgTG9naW5EZXRhaWxzPikge1xuICAgIGNvbnN0IGh0dHBPcHRpb25zOiB7XG4gICAgICBoZWFkZXJzOiBIdHRwSGVhZGVycztcbiAgICAgIGNvbnRleHQ/OiBIdHRwQ29udGV4dDtcbiAgICAgIG9ic2VydmU/OiAnYm9keSc7XG4gICAgICBwYXJhbXM/OiBIdHRwUGFyYW1zIHwgUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHJlYWRvbmx5IChzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuKVtdPjtcbiAgICAgIHJlcG9ydFByb2dyZXNzPzogYm9vbGVhbjtcbiAgICAgIHJlc3BvbnNlVHlwZTogJ2pzb24nIHwgdW5kZWZpbmVkO1xuICAgICAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgICB9ID0ge1xuICAgICAgd2l0aENyZWRlbnRpYWxzOiBvY2FwaUNvbmZpZy53aXRoQ3JlZGVudGlhbHMsXG4gICAgICBoZWFkZXJzOiB0aGlzLm9jYXBpSGVscGVyLmdldEh0dHBIZWFkZXJzKG9jYXBpQ29uZmlnKSxcbiAgICAgIHJlc3BvbnNlVHlwZTogJ2pzb24nLFxuICAgIH07XG5cbiAgICByZXR1cm4gaHR0cE9wdGlvbnM7XG4gIH1cbn1cbiJdfQ==