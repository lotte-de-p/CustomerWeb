import { AbstractAuthenticationService } from './authentication.service';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { of, throwError } from 'rxjs';
import { catchError, concatMap, map, switchMap } from 'rxjs/operators';
import { inject } from '@angular/core';
import { AuthenticationPrompt } from '../models';
import { LogFactory } from '@telenet/ng-lib-shared';
import { OcapiAuthenticationProvider } from '../providers';
export class TransparentAuthenticationService extends AbstractAuthenticationService {
    static LOG = LogFactory.createLogger(TransparentAuthenticationService);
    httpClient = inject(HttpClient);
    constructor() {
        super();
    }
    isAuthenticated() {
        return this.userDetailsService.getUserDetails().pipe(switchMap((loginDetails) => {
            if (loginDetails.isLoggedIn()) {
                return of(loginDetails.isLoggedIn());
            }
            return this.attemptAuthenticate(loginDetails.state, loginDetails.nonce).pipe(switchMap(() => {
                this.userDetailsService.reset();
                return this.userDetailsService.getUserDetails().pipe(map((loginDetails) => loginDetails.isLoggedIn()));
            }), catchError((error) => {
                this.getLog().logError('Failed to authenticate', error);
                return of(false);
            }));
        }));
    }
    getLog() {
        return TransparentAuthenticationService.LOG;
    }
    attemptAuthenticate(state, nonce) {
        let params = this.authenticationProvider.getParameters({ prompt: AuthenticationPrompt.NONE });
        if (state && nonce) {
            params = params.append('state', state).append('nonce', nonce);
        }
        this.getLog().logDebug(`Trying authenticate with provider ${this.authenticationProvider.getType()}`);
        if (!this.authenticationProvider.getAuthenticationUrl()) {
            return throwError(() => new Error('Authentication url is not defined, not trying to authenticate'));
        }
        return this.authenticationProvider.sendAuthCall(params).pipe(catchError((error) => {
            if (error?.error?.text?.includes('callback')) {
                TransparentAuthenticationService.LOG.logDebug(`Error during attempt to authenticate, with callback: ${error.error.text}`);
                return of({ data: error.error.text });
            }
            else {
                TransparentAuthenticationService.LOG.logDebug(`Error during attempt to authenticate, rethrowing: ${error?.error?.text}`);
                return of({ data: error.error.text });
            }
        }), concatMap((res) => {
            TransparentAuthenticationService.LOG.logDebug(`Executing callback: ${res.data}`);
            if (this.authenticationProvider.getType() === OcapiAuthenticationProvider.PROVIDER_TYPE) {
                // For ocapi we don't want to manually get a callback, this already happened via jsonp
                return of(undefined);
            }
            return this.httpClient.get(res.data, this.getCallBackOptions());
        }));
    }
    getCallBackOptions() {
        return {
            withCredentials: true,
            headers: new HttpHeaders({
                'X-Requested-With': 'XMLHttpRequest',
                Accept: 'text/plain',
                'Content-Type': 'text/plain;charset=UTF-8',
            }),
            responseType: 'text',
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNwYXJlbnQtYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvc2VydmljZXMvYXV0aGVudGljYXRpb24vc2VydmljZXMvdHJhbnNwYXJlbnQtYXV0aGVudGljYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RSxPQUFPLEVBQUUsVUFBVSxFQUFxQixXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRixPQUFPLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2QyxPQUFPLEVBQUUsb0JBQW9CLEVBQXlCLE1BQU0sV0FBVyxDQUFDO0FBQ3hFLE9BQU8sRUFBTyxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFM0QsTUFBTSxPQUFPLGdDQUFpQyxTQUFRLDZCQUE2QjtJQUN6RSxNQUFNLENBQVUsR0FBRyxHQUFRLFVBQVUsQ0FBQyxZQUFZLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUUxRSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRW5EO1FBQ0UsS0FBSyxFQUFFLENBQUM7SUFDVixDQUFDO0lBRWtCLGVBQWU7UUFDaEMsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUNsRCxTQUFTLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUN6QixJQUFJLFlBQVksQ0FBQyxV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QUFDO1lBQ2pGLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sRUFBRSxLQUFLLDJCQUEyQixDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUN4RixzRkFBc0Y7Z0JBQ3RGLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZCLENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVPLGtCQUFrQjtRQUN4QixPQUFPO1lBQ0wsZUFBZSxFQUFFLElBQUk7WUFDckIsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDO2dCQUN2QixrQkFBa0IsRUFBRSxnQkFBZ0I7Z0JBQ3BDLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixjQUFjLEVBQUUsMEJBQTBCO2FBQzNDLENBQUM7WUFDRixZQUFZLEVBQUUsTUFBTTtTQUNyQixDQUFDO0lBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFic3RyYWN0QXV0aGVudGljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9hdXRoZW50aWNhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBjb25jYXRNYXAsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBdXRoZW50aWNhdGlvblByb21wdCwgQXV0aGVudGljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IExvZywgTG9nRmFjdG9yeSB9IGZyb20gJ0B0ZWxlbmV0L25nLWxpYi1zaGFyZWQnO1xuaW1wb3J0IHsgT2NhcGlBdXRoZW50aWNhdGlvblByb3ZpZGVyIH0gZnJvbSAnLi4vcHJvdmlkZXJzJztcblxuZXhwb3J0IGNsYXNzIFRyYW5zcGFyZW50QXV0aGVudGljYXRpb25TZXJ2aWNlIGV4dGVuZHMgQWJzdHJhY3RBdXRoZW50aWNhdGlvblNlcnZpY2UgaW1wbGVtZW50cyBBdXRoZW50aWNhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBMT0c6IExvZyA9IExvZ0ZhY3RvcnkuY3JlYXRlTG9nZ2VyKFRyYW5zcGFyZW50QXV0aGVudGljYXRpb25TZXJ2aWNlKTtcblxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgaHR0cENsaWVudCA9IGluamVjdChIdHRwQ2xpZW50KTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHJvdGVjdGVkIG92ZXJyaWRlIGlzQXV0aGVudGljYXRlZCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy51c2VyRGV0YWlsc1NlcnZpY2UuZ2V0VXNlckRldGFpbHMoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChsb2dpbkRldGFpbHMpID0+IHtcbiAgICAgICAgaWYgKGxvZ2luRGV0YWlscy5pc0xvZ2dlZEluKCkpIHtcbiAgICAgICAgICByZXR1cm4gb2YobG9naW5EZXRhaWxzLmlzTG9nZ2VkSW4oKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5hdHRlbXB0QXV0aGVudGljYXRlKGxvZ2luRGV0YWlscy5zdGF0ZSwgbG9naW5EZXRhaWxzLm5vbmNlKS5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVzZXJEZXRhaWxzU2VydmljZS5yZXNldCgpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXNlckRldGFpbHNTZXJ2aWNlLmdldFVzZXJEZXRhaWxzKCkucGlwZShtYXAoKGxvZ2luRGV0YWlscykgPT4gbG9naW5EZXRhaWxzLmlzTG9nZ2VkSW4oKSkpO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdldExvZygpLmxvZ0Vycm9yKCdGYWlsZWQgdG8gYXV0aGVudGljYXRlJywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIG92ZXJyaWRlIGdldExvZygpOiBMb2cge1xuICAgIHJldHVybiBUcmFuc3BhcmVudEF1dGhlbnRpY2F0aW9uU2VydmljZS5MT0c7XG4gIH1cblxuICBwcml2YXRlIGF0dGVtcHRBdXRoZW50aWNhdGUoc3RhdGU6IHN0cmluZywgbm9uY2U6IHN0cmluZyk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuZ2V0UGFyYW1ldGVycyh7IHByb21wdDogQXV0aGVudGljYXRpb25Qcm9tcHQuTk9ORSB9KTtcblxuICAgIGlmIChzdGF0ZSAmJiBub25jZSkge1xuICAgICAgcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgnc3RhdGUnLCBzdGF0ZSkuYXBwZW5kKCdub25jZScsIG5vbmNlKTtcbiAgICB9XG5cbiAgICB0aGlzLmdldExvZygpLmxvZ0RlYnVnKGBUcnlpbmcgYXV0aGVudGljYXRlIHdpdGggcHJvdmlkZXIgJHt0aGlzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuZ2V0VHlwZSgpfWApO1xuXG4gICAgaWYgKCF0aGlzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuZ2V0QXV0aGVudGljYXRpb25VcmwoKSkge1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gbmV3IEVycm9yKCdBdXRoZW50aWNhdGlvbiB1cmwgaXMgbm90IGRlZmluZWQsIG5vdCB0cnlpbmcgdG8gYXV0aGVudGljYXRlJykpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuc2VuZEF1dGhDYWxsKHBhcmFtcykucGlwZShcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAoZXJyb3I/LmVycm9yPy50ZXh0Py5pbmNsdWRlcygnY2FsbGJhY2snKSkge1xuICAgICAgICAgIFRyYW5zcGFyZW50QXV0aGVudGljYXRpb25TZXJ2aWNlLkxPRy5sb2dEZWJ1ZyhcbiAgICAgICAgICAgIGBFcnJvciBkdXJpbmcgYXR0ZW1wdCB0byBhdXRoZW50aWNhdGUsIHdpdGggY2FsbGJhY2s6ICR7ZXJyb3IuZXJyb3IudGV4dH1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXR1cm4gb2YoeyBkYXRhOiBlcnJvci5lcnJvci50ZXh0IH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIFRyYW5zcGFyZW50QXV0aGVudGljYXRpb25TZXJ2aWNlLkxPRy5sb2dEZWJ1ZyhcbiAgICAgICAgICAgIGBFcnJvciBkdXJpbmcgYXR0ZW1wdCB0byBhdXRoZW50aWNhdGUsIHJldGhyb3dpbmc6ICR7ZXJyb3I/LmVycm9yPy50ZXh0fWBcbiAgICAgICAgICApO1xuICAgICAgICAgIHJldHVybiBvZih7IGRhdGE6IGVycm9yLmVycm9yLnRleHQgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgY29uY2F0TWFwKChyZXM6IHsgZGF0YTogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgVHJhbnNwYXJlbnRBdXRoZW50aWNhdGlvblNlcnZpY2UuTE9HLmxvZ0RlYnVnKGBFeGVjdXRpbmcgY2FsbGJhY2s6ICR7cmVzLmRhdGF9YCk7XG4gICAgICAgIGlmICh0aGlzLmF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuZ2V0VHlwZSgpID09PSBPY2FwaUF1dGhlbnRpY2F0aW9uUHJvdmlkZXIuUFJPVklERVJfVFlQRSkge1xuICAgICAgICAgIC8vIEZvciBvY2FwaSB3ZSBkb24ndCB3YW50IHRvIG1hbnVhbGx5IGdldCBhIGNhbGxiYWNrLCB0aGlzIGFscmVhZHkgaGFwcGVuZWQgdmlhIGpzb25wXG4gICAgICAgICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5nZXQocmVzLmRhdGEsIHRoaXMuZ2V0Q2FsbEJhY2tPcHRpb25zKCkpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYWxsQmFja09wdGlvbnMoKTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4ge1xuICAgIHJldHVybiB7XG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWUsXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCcsXG4gICAgICAgIEFjY2VwdDogJ3RleHQvcGxhaW4nLFxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvcGxhaW47Y2hhcnNldD1VVEYtOCcsXG4gICAgICB9KSxcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==