import { Inject, Injectable } from '@angular/core';
import * as udl from 'udl';
import { EventTypeEnum } from './enums/event-type.enum';
import { EventNameEnum } from './enums/event-name.enum';
import { EventStatusEnum } from './enums/event-status.enum';
import { mergeMap, tap } from 'rxjs/operators';
import { forkJoin, timer } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@telenet/ng-lib-message";
export class DataLayerService {
    messageService;
    window;
    dataLayer;
    constructor(messageService, window) {
        this.messageService = messageService;
        this.window = window;
    }
    init() {
        const udlObjectName = this.window['udlObjectName'];
        this.dataLayer = udl.DataLayer.create();
        if (this.window[udlObjectName] && udlObjectName) {
            let componentList = this.dataLayer.getComponents();
            if (componentList && componentList.length > 0) {
                componentList = componentList.map(function (componentItem) {
                    return new udl.Component(componentItem);
                });
            }
            this.dataLayer.setComponents(componentList);
        }
        return true;
    }
    getDataLayer() {
        return this.dataLayer;
    }
    setPage(page) {
        if (this.dataLayer) {
            return this.dataLayer.setPage(page);
        }
        return new Promise(() => false);
    }
    getCategory(componentInstanceId) {
        if (this.dataLayer) {
            return this.dataLayer.getCategory(componentInstanceId);
        }
        return null;
    }
    createCategory(primaryCategory = '', subCategory1) {
        const category = new udl.Category();
        category.setPrimaryCategory(primaryCategory);
        if (subCategory1) {
            category.setSubCategory1(subCategory1);
        }
        return category;
    }
    addPageEvent(pageId, attributes) {
        const pageInfoObject = new udl.PageInfo();
        pageInfoObject.setPageID(pageId);
        pageInfoObject.setPageName(pageId);
        pageInfoObject.setLanguage(this.dataLayer.getPage().getPageInfo().getLanguage());
        const page = new udl.Page({ pageInfo: pageInfoObject });
        if (attributes) {
            Object.keys(attributes).forEach((key) => page.addAttribute(key, attributes[key]));
        }
        this.setPage(page).then();
    }
    addStepViewEvent(attributes) {
        const event = new udl.Event();
        const eventInfo = this.createEventInfo(EventNameEnum.EVENT_NAME_VIEW_STEP);
        event.setEventInfo(eventInfo);
        event.setAttributes(attributes);
        if (this.dataLayer) {
            return this.dataLayer.addStepViewEvent(event);
        }
        return new Promise(() => false);
    }
    createEvent(eventProperties) {
        const { eventInfo, attributes, strategy, category, directCallLabel } = eventProperties;
        const event = new udl.Event();
        event.setEventInfo(eventInfo);
        event.setAttributes(attributes);
        if (strategy) {
            event.setStrategy(strategy);
        }
        if (category) {
            event.setCategory(category);
        }
        if (directCallLabel) {
            event.setDirectCallLabel(directCallLabel);
        }
        return event;
    }
    sendEvent(eventProperties) {
        const event = this.createEvent(eventProperties);
        if (this.dataLayer) {
            return this.dataLayer.addEvent(event);
        }
        return new Promise(() => false);
    }
    addEvent(eventInfo, attributes, category, directCallLabel) {
        const event = new udl.Event();
        event.setEventInfo(eventInfo);
        event.setAttributes(attributes);
        if (category) {
            event.setCategory(category);
        }
        if (directCallLabel) {
            event.setDirectCallLabel(directCallLabel);
        }
        if (this.dataLayer) {
            return this.dataLayer.addEvent(event);
        }
        return new Promise(() => false);
    }
    addStepLoadTimeEvent(attributes) {
        const eventInfo = this.createEventInfo(EventNameEnum.EVENT_NAME_STEP_LOAD_TIME, EventTypeEnum.EVENT_TYPE_STEP_LOAD_TIME);
        return this.addEvent(eventInfo, attributes);
    }
    setCart(cart) {
        if (this.dataLayer) {
            return this.dataLayer.setCart(cart);
        }
        return new Promise(() => false);
    }
    getCart() {
        if (this.dataLayer) {
            return this.dataLayer.getCart();
        }
        return null;
    }
    createEventInfo(eventName, eventType, messageGroups) {
        const eventInfo = new udl.EventInfo();
        eventInfo.setEventName(eventName);
        eventInfo.setType(eventType ?? '');
        eventInfo.setEventStatus(this.getStatus(messageGroups?.length ? messageGroups : []));
        eventInfo.setEventStatusMessage(this.getStatusMessage(messageGroups?.length ? messageGroups : []));
        return eventInfo;
    }
    createCart(cartId, price) {
        const cart = new udl.Cart();
        cart.setCartID(cartId);
        cart.setPrice(price ?? new udl.Price());
        return cart;
    }
    createTransaction(transactionId, price) {
        const transaction = new udl.Transaction();
        transaction.setTransactionID(transactionId);
        transaction.setPrice(price);
        return transaction;
    }
    setTransaction(transaction) {
        if (this.dataLayer) {
            return this.dataLayer.setTransaction(transaction);
        }
        return new Promise(() => false);
    }
    createPrice(oneTimePrice, recurringPrice, basePrice, totalPrice, discountedPrice) {
        const price = new udl.Price();
        price.setOnetimePrice(oneTimePrice ?? 0);
        price.setRecurringPrice(recurringPrice ?? 0);
        price.setBasePrice(basePrice ?? new udl.Price());
        price.setTotalPrice(totalPrice ?? new udl.Price());
        price.setDiscountedPrice(discountedPrice ?? new udl.Price());
        return price;
    }
    createProductInfo(productId, productName, productType, productStatus) {
        const product = new udl.Product();
        product.setProductID(productId);
        product.setProductName(productName ?? '');
        product.setProductType(productType ?? '');
        product.setProductStatus(productStatus ?? '');
        return product;
    }
    createItem(productInfo, price, quantity) {
        const item = new udl.Item();
        item.setProductInfo(productInfo);
        item.setPrice(price ?? new udl.Price());
        item.setQuantity(quantity ?? 0);
        return item;
    }
    getStatus(messageGroups) {
        if (messageGroups?.length) {
            for (const messageGroup of messageGroups) {
                if (this.messageService.hasErrorMessages(messageGroup)) {
                    return EventStatusEnum.EVENT_STATUS_FAILED;
                }
            }
            return EventStatusEnum.EVENT_STATUS_SUCCESS;
        }
        return EventStatusEnum.EVENT_STATUS_MESSAGE_EMPTY;
    }
    getStatusMessage(messageGroups) {
        let statusMessages = '';
        let messagesFromMessageService = [];
        if (messageGroups?.length) {
            for (const messageGroup of messageGroups) {
                if (this.messageService.hasErrorMessages(messageGroup)) {
                    messagesFromMessageService = messagesFromMessageService.concat(this.messageService.getErrorMessages(messageGroup));
                }
            }
            messagesFromMessageService = messagesFromMessageService.filter((msg) => msg.type !== 'success');
            statusMessages = messagesFromMessageService.map((msg) => msg['_key']).join(',');
        }
        return statusMessages;
    }
    getAnalyticsPromises() {
        if (this.dataLayer) {
            return this.dataLayer.getAnalyticsPromises();
        }
        return [];
    }
    rollbackStepIdToParent(stepId) {
        timer(100)
            .pipe(mergeMap(() => {
            const analyticsPromises = this.getAnalyticsPromises();
            return forkJoin(analyticsPromises);
        }), tap(() => this.getDataLayer().getPage().getPageInfo().setStepId(stepId)))
            .subscribe();
    }
    static ɵfac = function DataLayerService_Factory(t) { return new (t || DataLayerService)(i0.ɵɵinject(i1.MessageService), i0.ɵɵinject('Window')); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: DataLayerService, factory: DataLayerService.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(DataLayerService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], () => [{ type: i1.MessageService }, { type: undefined, decorators: [{
                type: Inject,
                args: ['Window']
            }] }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWxheWVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2RhdGFsYXllci9kYXRhbGF5ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEtBQUssR0FBRyxNQUFNLEtBQUssQ0FBQztBQUMzQixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRS9DLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7QUFNdkMsTUFBTSxPQUFPLGdCQUFnQjtJQUlSO0lBRUE7SUFMWCxTQUFTLENBQWlCO0lBRWxDLFlBQ21CLGNBQThCLEVBRTlCLE1BQStCO1FBRi9CLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUU5QixXQUFNLEdBQU4sTUFBTSxDQUF5QjtJQUMvQyxDQUFDO0lBRUosSUFBSTtRQUNGLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFXLENBQUM7UUFDN0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3hDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUNoRCxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ25ELElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FB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QUFnQixtQkFGZixNQUFNOztpRkFFUCxnQkFBZ0I7Y0FINUIsVUFBVTtlQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COztzQkFNSSxNQUFNO3VCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIHVkbCBmcm9tICd1ZGwnO1xuaW1wb3J0IHsgRXZlbnRUeXBlRW51bSB9IGZyb20gJy4vZW51bXMvZXZlbnQtdHlwZS5lbnVtJztcbmltcG9ydCB7IERhdGFMYXllckF0dHJpYnV0ZXMgfSBmcm9tICcuL2ludGVyZmFjZXMvZGF0YS1sYXllci1hdHRyaWJ1dGVzJztcbmltcG9ydCB7IEV2ZW50TmFtZUVudW0gfSBmcm9tICcuL2VudW1zL2V2ZW50LW5hbWUuZW51bSc7XG5pbXBvcnQgeyBFdmVudFN0YXR1c0VudW0gfSBmcm9tICcuL2VudW1zL2V2ZW50LXN0YXR1cy5lbnVtJztcbmltcG9ydCB7IEFic3RyYWN0TWVzc2FnZSwgTWVzc2FnZVNlcnZpY2UgfSBmcm9tICdAdGVsZW5ldC9uZy1saWItbWVzc2FnZSc7XG5pbXBvcnQgeyBtZXJnZU1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGlyZWN0Q2FsbExhYmVsRW51bSB9IGZyb20gJ3VkbCc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEV2ZW50UHJvcGVydGllcyB9IGZyb20gJy4vaW50ZXJmYWNlcy91ZGwtZXZlbnQtcHJvcGVydGllcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBEYXRhTGF5ZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBkYXRhTGF5ZXIhOiB1ZGwuRGF0YUxheWVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWVzc2FnZVNlcnZpY2U6IE1lc3NhZ2VTZXJ2aWNlLFxuICAgIEBJbmplY3QoJ1dpbmRvdycpXG4gICAgcHJpdmF0ZSByZWFkb25seSB3aW5kb3c6IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICkge31cblxuICBpbml0KCkge1xuICAgIGNvbnN0IHVkbE9iamVjdE5hbWUgPSB0aGlzLndpbmRvd1sndWRsT2JqZWN0TmFtZSddIGFzIHN0cmluZztcbiAgICB0aGlzLmRhdGFMYXllciA9IHVkbC5EYXRhTGF5ZXIuY3JlYXRlKCk7XG4gICAgaWYgKHRoaXMud2luZG93W3VkbE9iamVjdE5hbWVdICYmIHVkbE9iamVjdE5hbWUpIHtcbiAgICAgIGxldCBjb21wb25lbnRMaXN0ID0gdGhpcy5kYXRhTGF5ZXIuZ2V0Q29tcG9uZW50cygpO1xuICAgICAgaWYgKGNvbXBvbmVudExpc3QgJiYgY29tcG9uZW50TGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbXBvbmVudExpc3QgPSBjb21wb25lbnRMaXN0Lm1hcChmdW5jdGlvbiAoY29tcG9uZW50SXRlbSkge1xuICAgICAgICAgIHJldHVybiBuZXcgdWRsLkNvbXBvbmVudChjb21wb25lbnRJdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLmRhdGFMYXllci5zZXRDb21wb25lbnRzKGNvbXBvbmVudExpc3QpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGdldERhdGFMYXllcigpOiB1ZGwuRGF0YUxheWVyIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXI7XG4gIH1cblxuICBzZXRQYWdlKHBhZ2U6IHVkbC5QYWdlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMuZGF0YUxheWVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXIuc2V0UGFnZShwYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKCgpID0+IGZhbHNlKTtcbiAgfVxuXG4gIGdldENhdGVnb3J5KGNvbXBvbmVudEluc3RhbmNlSWQ6IHN0cmluZyk6IHVkbC5DYXRlZ29yeSB8IG51bGwge1xuICAgIGlmICh0aGlzLmRhdGFMYXllcikge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YUxheWVyLmdldENhdGVnb3J5KGNvbXBvbmVudEluc3RhbmNlSWQpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNyZWF0ZUNhdGVnb3J5KHByaW1hcnlDYXRlZ29yeTogc3RyaW5nID0gJycsIHN1YkNhdGVnb3J5MT86IHN0cmluZyk6IHVkbC5DYXRlZ29yeSB7XG4gICAgY29uc3QgY2F0ZWdvcnkgPSBuZXcgdWRsLkNhdGVnb3J5KCk7XG4gICAgY2F0ZWdvcnkuc2V0UHJpbWFyeUNhdGVnb3J5KHByaW1hcnlDYXRlZ29yeSk7XG4gICAgaWYgKHN1YkNhdGVnb3J5MSkge1xuICAgICAgY2F0ZWdvcnkuc2V0U3ViQ2F0ZWdvcnkxKHN1YkNhdGVnb3J5MSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhdGVnb3J5O1xuICB9XG5cbiAgYWRkUGFnZUV2ZW50KHBhZ2VJZDogc3RyaW5nLCBhdHRyaWJ1dGVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgYm9vbGVhbiB8IG51bWJlcj4pOiB2b2lkIHtcbiAgICBjb25zdCBwYWdlSW5mb09iamVjdCA9IG5ldyB1ZGwuUGFnZUluZm8oKTtcbiAgICBwYWdlSW5mb09iamVjdC5zZXRQYWdlSUQocGFnZUlkKTtcbiAgICBwYWdlSW5mb09iamVjdC5zZXRQYWdlTmFtZShwYWdlSWQpO1xuICAgIHBhZ2VJbmZvT2JqZWN0LnNldExhbmd1YWdlKHRoaXMuZGF0YUxheWVyLmdldFBhZ2UoKS5nZXRQYWdlSW5mbygpLmdldExhbmd1YWdlKCkpO1xuXG4gICAgY29uc3QgcGFnZSA9IG5ldyB1ZGwuUGFnZSh7IHBhZ2VJbmZvOiBwYWdlSW5mb09iamVjdCB9KTtcbiAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgT2JqZWN0LmtleXMoYXR0cmlidXRlcykuZm9yRWFjaCgoa2V5KSA9PiBwYWdlLmFkZEF0dHJpYnV0ZShrZXksIGF0dHJpYnV0ZXNba2V5XSkpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0UGFnZShwYWdlKS50aGVuKCk7XG4gIH1cblxuICBhZGRTdGVwVmlld0V2ZW50KGF0dHJpYnV0ZXM6IERhdGFMYXllckF0dHJpYnV0ZXMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBldmVudCA9IG5ldyB1ZGwuRXZlbnQoKTtcbiAgICBjb25zdCBldmVudEluZm8gPSB0aGlzLmNyZWF0ZUV2ZW50SW5mbyhFdmVudE5hbWVFbnVtLkVWRU5UX05BTUVfVklFV19TVEVQKTtcbiAgICBldmVudC5zZXRFdmVudEluZm8oZXZlbnRJbmZvKTtcbiAgICBldmVudC5zZXRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpO1xuXG4gICAgaWYgKHRoaXMuZGF0YUxheWVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXIuYWRkU3RlcFZpZXdFdmVudChldmVudCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoKSA9PiBmYWxzZSk7XG4gIH1cblxuICBjcmVhdGVFdmVudChldmVudFByb3BlcnRpZXM6IEV2ZW50UHJvcGVydGllcyk6IHVkbC5FdmVudCB7XG4gICAgY29uc3QgeyBldmVudEluZm8sIGF0dHJpYnV0ZXMsIHN0cmF0ZWd5LCBjYXRlZ29yeSwgZGlyZWN0Q2FsbExhYmVsIH0gPSBldmVudFByb3BlcnRpZXM7XG4gICAgY29uc3QgZXZlbnQgPSBuZXcgdWRsLkV2ZW50KCk7XG4gICAgZXZlbnQuc2V0RXZlbnRJbmZvKGV2ZW50SW5mbyk7XG4gICAgZXZlbnQuc2V0QXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcbiAgICBpZiAoc3RyYXRlZ3kpIHtcbiAgICAgIGV2ZW50LnNldFN0cmF0ZWd5KHN0cmF0ZWd5KTtcbiAgICB9XG5cbiAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgIGV2ZW50LnNldENhdGVnb3J5KGNhdGVnb3J5KTtcbiAgICB9XG5cbiAgICBpZiAoZGlyZWN0Q2FsbExhYmVsKSB7XG4gICAgICBldmVudC5zZXREaXJlY3RDYWxsTGFiZWwoZGlyZWN0Q2FsbExhYmVsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBzZW5kRXZlbnQoZXZlbnRQcm9wZXJ0aWVzOiBFdmVudFByb3BlcnRpZXMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBldmVudCA9IHRoaXMuY3JlYXRlRXZlbnQoZXZlbnRQcm9wZXJ0aWVzKTtcbiAgICBpZiAodGhpcy5kYXRhTGF5ZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGFMYXllci5hZGRFdmVudChldmVudCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoKSA9PiBmYWxzZSk7XG4gIH1cblxuICBhZGRFdmVudChcbiAgICBldmVudEluZm86IHVkbC5FdmVudEluZm8sXG4gICAgYXR0cmlidXRlczogRGF0YUxheWVyQXR0cmlidXRlcyxcbiAgICBjYXRlZ29yeT86IHVkbC5DYXRlZ29yeSxcbiAgICBkaXJlY3RDYWxsTGFiZWw/OiB1ZGwuRGlyZWN0Q2FsbExhYmVsRW51bVxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBldmVudCA9IG5ldyB1ZGwuRXZlbnQoKTtcbiAgICBldmVudC5zZXRFdmVudEluZm8oZXZlbnRJbmZvKTtcbiAgICBldmVudC5zZXRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpO1xuXG4gICAgaWYgKGNhdGVnb3J5KSB7XG4gICAgICBldmVudC5zZXRDYXRlZ29yeShjYXRlZ29yeSk7XG4gICAgfVxuXG4gICAgaWYgKGRpcmVjdENhbGxMYWJlbCkge1xuICAgICAgZXZlbnQuc2V0RGlyZWN0Q2FsbExhYmVsKGRpcmVjdENhbGxMYWJlbCBhcyBEaXJlY3RDYWxsTGFiZWxFbnVtKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kYXRhTGF5ZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGFMYXllci5hZGRFdmVudChldmVudCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoKSA9PiBmYWxzZSk7XG4gIH1cblxuICBhZGRTdGVwTG9hZFRpbWVFdmVudChhdHRyaWJ1dGVzOiBEYXRhTGF5ZXJBdHRyaWJ1dGVzKSB7XG4gICAgY29uc3QgZXZlbnRJbmZvID0gdGhpcy5jcmVhdGVFdmVudEluZm8oXG4gICAgICBFdmVudE5hbWVFbnVtLkVWRU5UX05BTUVfU1RFUF9MT0FEX1RJTUUsXG4gICAgICBFdmVudFR5cGVFbnVtLkVWRU5UX1RZUEVfU1RFUF9MT0FEX1RJTUVcbiAgICApO1xuICAgIHJldHVybiB0aGlzLmFkZEV2ZW50KGV2ZW50SW5mbywgYXR0cmlidXRlcyk7XG4gIH1cblxuICBzZXRDYXJ0KGNhcnQ6IHVkbC5DYXJ0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMuZGF0YUxheWVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXIuc2V0Q2FydChjYXJ0KTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKCgpID0+IGZhbHNlKTtcbiAgfVxuXG4gIGdldENhcnQoKTogdWRsLkNhcnQgfCBudWxsIHtcbiAgICBpZiAodGhpcy5kYXRhTGF5ZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGFMYXllci5nZXRDYXJ0KCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY3JlYXRlRXZlbnRJbmZvKGV2ZW50TmFtZTogc3RyaW5nLCBldmVudFR5cGU/OiBzdHJpbmcsIG1lc3NhZ2VHcm91cHM/OiBzdHJpbmdbXSk6IHVkbC5FdmVudEluZm8ge1xuICAgIGNvbnN0IGV2ZW50SW5mbyA9IG5ldyB1ZGwuRXZlbnRJbmZvKCk7XG4gICAgZXZlbnRJbmZvLnNldEV2ZW50TmFtZShldmVudE5hbWUpO1xuICAgIGV2ZW50SW5mby5zZXRUeXBlKGV2ZW50VHlwZSA/PyAnJyk7XG4gICAgZXZlbnRJbmZvLnNldEV2ZW50U3RhdHVzKHRoaXMuZ2V0U3RhdHVzKG1lc3NhZ2VHcm91cHM/Lmxlbmd0aCA/IG1lc3NhZ2VHcm91cHMgOiBbXSkpO1xuICAgIGV2ZW50SW5mby5zZXRFdmVudFN0YXR1c01lc3NhZ2UodGhpcy5nZXRTdGF0dXNNZXNzYWdlKG1lc3NhZ2VHcm91cHM/Lmxlbmd0aCA/IG1lc3NhZ2VHcm91cHMgOiBbXSkpO1xuICAgIHJldHVybiBldmVudEluZm87XG4gIH1cblxuICBjcmVhdGVDYXJ0KGNhcnRJZDogc3RyaW5nLCBwcmljZT86IHVkbC5QcmljZSk6IHVkbC5DYXJ0IHtcbiAgICBjb25zdCBjYXJ0ID0gbmV3IHVkbC5DYXJ0KCk7XG4gICAgY2FydC5zZXRDYXJ0SUQoY2FydElkKTtcbiAgICBjYXJ0LnNldFByaWNlKHByaWNlID8/IG5ldyB1ZGwuUHJpY2UoKSk7XG5cbiAgICByZXR1cm4gY2FydDtcbiAgfVxuXG4gIGNyZWF0ZVRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uSWQ6IHN0cmluZywgcHJpY2U6IHVkbC5QcmljZSk6IHVkbC5UcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgdHJhbnNhY3Rpb24gPSBuZXcgdWRsLlRyYW5zYWN0aW9uKCk7XG4gICAgdHJhbnNhY3Rpb24uc2V0VHJhbnNhY3Rpb25JRCh0cmFuc2FjdGlvbklkKTtcbiAgICB0cmFuc2FjdGlvbi5zZXRQcmljZShwcmljZSk7XG5cbiAgICByZXR1cm4gdHJhbnNhY3Rpb247XG4gIH1cblxuICBzZXRUcmFuc2FjdGlvbih0cmFuc2FjdGlvbjogdWRsLlRyYW5zYWN0aW9uKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMuZGF0YUxheWVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXIuc2V0VHJhbnNhY3Rpb24odHJhbnNhY3Rpb24pO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKCkgPT4gZmFsc2UpO1xuICB9XG5cbiAgY3JlYXRlUHJpY2UoXG4gICAgb25lVGltZVByaWNlPzogbnVtYmVyLFxuICAgIHJlY3VycmluZ1ByaWNlPzogbnVtYmVyLFxuICAgIGJhc2VQcmljZT86IHVkbC5QcmljZSxcbiAgICB0b3RhbFByaWNlPzogdWRsLlByaWNlLFxuICAgIGRpc2NvdW50ZWRQcmljZT86IHVkbC5QcmljZVxuICApIHtcbiAgICBjb25zdCBwcmljZSA9IG5ldyB1ZGwuUHJpY2UoKTtcbiAgICBwcmljZS5zZXRPbmV0aW1lUHJpY2Uob25lVGltZVByaWNlID8/IDApO1xuICAgIHByaWNlLnNldFJlY3VycmluZ1ByaWNlKHJlY3VycmluZ1ByaWNlID8/IDApO1xuICAgIHByaWNlLnNldEJhc2VQcmljZShiYXNlUHJpY2UgPz8gbmV3IHVkbC5QcmljZSgpKTtcbiAgICBwcmljZS5zZXRUb3RhbFByaWNlKHRvdGFsUHJpY2UgPz8gbmV3IHVkbC5QcmljZSgpKTtcbiAgICBwcmljZS5zZXREaXNjb3VudGVkUHJpY2UoZGlzY291bnRlZFByaWNlID8/IG5ldyB1ZGwuUHJpY2UoKSk7XG5cbiAgICByZXR1cm4gcHJpY2U7XG4gIH1cblxuICBjcmVhdGVQcm9kdWN0SW5mbyhwcm9kdWN0SWQ6IHN0cmluZywgcHJvZHVjdE5hbWU/OiBzdHJpbmcsIHByb2R1Y3RUeXBlPzogc3RyaW5nLCBwcm9kdWN0U3RhdHVzPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcHJvZHVjdCA9IG5ldyB1ZGwuUHJvZHVjdCgpO1xuICAgIHByb2R1Y3Quc2V0UHJvZHVjdElEKHByb2R1Y3RJZCk7XG4gICAgcHJvZHVjdC5zZXRQcm9kdWN0TmFtZShwcm9kdWN0TmFtZSA/PyAnJyk7XG4gICAgcHJvZHVjdC5zZXRQcm9kdWN0VHlwZShwcm9kdWN0VHlwZSA/PyAnJyk7XG4gICAgcHJvZHVjdC5zZXRQcm9kdWN0U3RhdHVzKHByb2R1Y3RTdGF0dXMgPz8gJycpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Q7XG4gIH1cblxuICBjcmVhdGVJdGVtKHByb2R1Y3RJbmZvOiB1ZGwuUHJvZHVjdCwgcHJpY2U/OiB1ZGwuUHJpY2UsIHF1YW50aXR5PzogbnVtYmVyKSB7XG4gICAgY29uc3QgaXRlbSA9IG5ldyB1ZGwuSXRlbSgpO1xuICAgIGl0ZW0uc2V0UHJvZHVjdEluZm8ocHJvZHVjdEluZm8pO1xuICAgIGl0ZW0uc2V0UHJpY2UocHJpY2UgPz8gbmV3IHVkbC5QcmljZSgpKTtcbiAgICBpdGVtLnNldFF1YW50aXR5KHF1YW50aXR5ID8/IDApO1xuXG4gICAgcmV0dXJuIGl0ZW07XG4gIH1cblxuICBwcml2YXRlIGdldFN0YXR1cyhtZXNzYWdlR3JvdXBzOiBzdHJpbmdbXSk6IHN0cmluZyB7XG4gICAgaWYgKG1lc3NhZ2VHcm91cHM/Lmxlbmd0aCkge1xuICAgICAgZm9yIChjb25zdCBtZXNzYWdlR3JvdXAgb2YgbWVzc2FnZUdyb3Vwcykge1xuICAgICAgICBpZiAodGhpcy5tZXNzYWdlU2VydmljZS5oYXNFcnJvck1lc3NhZ2VzKG1lc3NhZ2VHcm91cCkpIHtcbiAgICAgICAgICByZXR1cm4gRXZlbnRTdGF0dXNFbnVtLkVWRU5UX1NUQVRVU19GQUlMRUQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBFdmVudFN0YXR1c0VudW0uRVZFTlRfU1RBVFVTX1NVQ0NFU1M7XG4gICAgfVxuICAgIHJldHVybiBFdmVudFN0YXR1c0VudW0uRVZFTlRfU1RBVFVTX01FU1NBR0VfRU1QVFk7XG4gIH1cblxuICBwcml2YXRlIGdldFN0YXR1c01lc3NhZ2UobWVzc2FnZUdyb3Vwczogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgIGxldCBzdGF0dXNNZXNzYWdlcyA9ICcnO1xuICAgIGxldCBtZXNzYWdlc0Zyb21NZXNzYWdlU2VydmljZTogQWJzdHJhY3RNZXNzYWdlW10gPSBbXTtcbiAgICBpZiAobWVzc2FnZUdyb3Vwcz8ubGVuZ3RoKSB7XG4gICAgICBmb3IgKGNvbnN0IG1lc3NhZ2VHcm91cCBvZiBtZXNzYWdlR3JvdXBzKSB7XG4gICAgICAgIGlmICh0aGlzLm1lc3NhZ2VTZXJ2aWNlLmhhc0Vycm9yTWVzc2FnZXMobWVzc2FnZUdyb3VwKSkge1xuICAgICAgICAgIG1lc3NhZ2VzRnJvbU1lc3NhZ2VTZXJ2aWNlID0gbWVzc2FnZXNGcm9tTWVzc2FnZVNlcnZpY2UuY29uY2F0KFxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS5nZXRFcnJvck1lc3NhZ2VzKG1lc3NhZ2VHcm91cClcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBtZXNzYWdlc0Zyb21NZXNzYWdlU2VydmljZSA9IG1lc3NhZ2VzRnJvbU1lc3NhZ2VTZXJ2aWNlLmZpbHRlcigobXNnKSA9PiBtc2cudHlwZSAhPT0gJ3N1Y2Nlc3MnKTtcbiAgICAgIHN0YXR1c01lc3NhZ2VzID0gbWVzc2FnZXNGcm9tTWVzc2FnZVNlcnZpY2UubWFwKChtc2cpID0+IG1zZ1snX2tleSddKS5qb2luKCcsJyk7XG4gICAgfVxuICAgIHJldHVybiBzdGF0dXNNZXNzYWdlcztcbiAgfVxuXG4gIGdldEFuYWx5dGljc1Byb21pc2VzKCk6IFByb21pc2U8Ym9vbGVhbj5bXSB7XG4gICAgaWYgKHRoaXMuZGF0YUxheWVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhTGF5ZXIuZ2V0QW5hbHl0aWNzUHJvbWlzZXMoKTtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgcm9sbGJhY2tTdGVwSWRUb1BhcmVudChzdGVwSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRpbWVyKDEwMClcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgYW5hbHl0aWNzUHJvbWlzZXMgPSB0aGlzLmdldEFuYWx5dGljc1Byb21pc2VzKCk7XG4gICAgICAgICAgcmV0dXJuIGZvcmtKb2luKGFuYWx5dGljc1Byb21pc2VzKTtcbiAgICAgICAgfSksXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmdldERhdGFMYXllcigpLmdldFBhZ2UoKS5nZXRQYWdlSW5mbygpLnNldFN0ZXBJZChzdGVwSWQpKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=