import { forkJoin, of } from 'rxjs';
import { map } from 'rxjs/operators';
import { Param, RequestParam } from '../interfaces/request-param';
import { Injectable } from '@angular/core';
import { NBAList } from './nba-list.model';
import { NBA } from './nba.model';
import { SellingArgument } from './selling-argument.model';
import { Builder } from '@telenet/ng-lib-shared';
import * as i0 from "@angular/core";
import * as i1 from "../../../../sales/service/sales-data.service";
import * as i2 from "@telenet/ng-lib-page";
export class NBARequestParameters {
    salesDataService;
    jsonUrlService;
    nbaRequestParameters;
    requestObservables;
    constructor(salesDataService, jsonUrlService) {
        this.salesDataService = salesDataService;
        this.jsonUrlService = jsonUrlService;
        const url = window.location.href;
        this.nbaRequestParameters = Object.keys(Param)
            .map((param) => {
            const value = new URL(url).searchParams.get(param);
            return value ? new RequestParam(param, value) : undefined;
        })
            .filter((el) => el !== undefined);
    }
    toNBAList() {
        if (this.getRequestParamValue(Param.t) !== 'nbo') {
            return of(new NBAList());
        }
        else {
            this.requestObservables = [];
            this.requestObservables.push(this.salesDataService.getDecompressedSalesData(this.getRequestParamValue(Param.sdata)));
            if (this.getRequestParamValue(Param.tid)) {
                this.requestObservables.push(this.deCompressRequestParamValue(this.getRequestParamValue(Param.tid)).pipe(map((treatmentId) => treatmentId)));
            }
            if (this.getRequestParamValue(Param.pt)) {
                this.requestObservables.push(this.deCompressRequestParamValue(this.getRequestParamValue(Param.pt)).pipe(map((productType) => productType)));
            }
            if (this.getRequestParamValue(Param.aid)) {
                this.requestObservables.push(this.deCompressRequestParamValue(this.getRequestParamValue(Param.aid)).pipe(map((name) => name)));
            }
            return this.constructNbaListFromRequestParam();
        }
    }
    constructNbaListFromRequestParam() {
        return forkJoin(this.requestObservables).pipe(map(([salesDataDecompressed, treatmentId, productType, name]) => {
            const nba = Builder(NBA)
                // @ts-ignore
                .sdata(salesDataDecompressed)
                .sellingArguments(this.createSellingArguments(this.getRequestParamValueAsArray(Param.sa)))
                .campaignId(this.getRequestParamValue(Param.cid))
                .treatment(treatmentId ? treatmentId['tid'] : '')
                .productType(productType ? productType['pt'] : '')
                .name(name ? name['aid'] : '')
                .build();
            return (Builder(NBAList)
                // @ts-ignore
                .actions([nba])
                .channel(this.getRequestParamValue(Param.src))
                .interactionId(this.getRequestParamValue(Param.did))
                .v(this.getRequestParamValue(Param.v))
                .isSuccess(true)
                .build());
        }));
    }
    getRequestParam(key) {
        return this.nbaRequestParameters.find((param) => param.key === key);
    }
    getRequestParamValue(key) {
        const requestParam = this.getRequestParam(key);
        return requestParam ? requestParam.value : '';
    }
    getRequestParamValueAsArray(key) {
        const requestParam = this.getRequestParam(key);
        return requestParam ? requestParam.value.split(',') : [];
    }
    createSellingArguments(sa) {
        let rank = 1;
        const sellingArguments = [];
        sa.forEach((saParam) => sellingArguments.push(new SellingArgument(saParam, rank++)));
        return sellingArguments;
    }
    deCompressRequestParamValue(paramValue) {
        return this.jsonUrlService.decompress(paramValue);
    }
    static ɵfac = function NBARequestParameters_Factory(t) { return new (t || NBARequestParameters)(i0.ɵɵinject(i1.SalesDataService), i0.ɵɵinject(i2.JsonUrlService)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: NBARequestParameters, factory: NBARequestParameters.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(NBARequestParameters, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], () => [{ type: i1.SalesDataService }, { type: i2.JsonUrlService }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmJhLXJlcXVlc3QtcGFyYW1ldGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9wZWdhL25iYS92MS9tb2RlbHMvbmJhLXJlcXVlc3QtcGFyYW1ldGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUUzRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7Ozs7QUFJakQsTUFBTSxPQUFPLG9CQUFvQjtJQUtaO0lBQ0E7SUFMRixvQkFBb0IsQ0FBaUI7SUFDOUMsa0JBQWtCLENBQXdCO0lBRWxELFlBQ21CLGdCQUFrQyxFQUNsQyxjQUE4QjtRQUQ5QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUUvQyxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDM0MsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDYixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxD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QUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQyxPQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMzRCxDQUFDO0lBRU8sc0JBQXNCLENBQUMsRUFBWTtRQUN6QyxJQUFJLElBQUksR0FBRyxDQUFDLENBQUM7UUFDYixNQUFNLGdCQUFnQixHQUFzQixFQUFFLENBQUM7UUFDL0MsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksZUFBZSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVyRixPQUFPLGdCQUFnQixDQUFDO0lBQzFCLENBQUM7SUFFTywyQkFBMkIsQ0FBQyxVQUFrQjtRQUNwRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBd0IsQ0FBQztJQUMzRSxDQUFDOzhFQW5HVSxvQkFBb0I7Z0VBQXBCLG9CQUFvQixXQUFwQixvQkFBb0IsbUJBRFAsTUFBTTs7aUZBQ25CLG9CQUFvQjtjQURoQyxVQUFVO2VBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQYXJhbSwgUmVxdWVzdFBhcmFtIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9yZXF1ZXN0LXBhcmFtJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEpzb25VcmxTZXJ2aWNlIH0gZnJvbSAnQHRlbGVuZXQvbmctbGliLXBhZ2UnO1xuaW1wb3J0IHsgTkJBTGlzdCB9IGZyb20gJy4vbmJhLWxpc3QubW9kZWwnO1xuaW1wb3J0IHsgTkJBIH0gZnJvbSAnLi9uYmEubW9kZWwnO1xuaW1wb3J0IHsgU2VsbGluZ0FyZ3VtZW50IH0gZnJvbSAnLi9zZWxsaW5nLWFyZ3VtZW50Lm1vZGVsJztcbmltcG9ydCB7IFNhbGVzRGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zYWxlcy9zZXJ2aWNlL3NhbGVzLWRhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBCdWlsZGVyIH0gZnJvbSAnQHRlbGVuZXQvbmctbGliLXNoYXJlZCc7XG5pbXBvcnQgeyBTYWxlc0RhdGEgfSBmcm9tICcuLi8uLi8uLi8uLi9zYWxlcy9tb2RlbHMvc2FsZXMtZGF0YS5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgTkJBUmVxdWVzdFBhcmFtZXRlcnMge1xuICBwcml2YXRlIHJlYWRvbmx5IG5iYVJlcXVlc3RQYXJhbWV0ZXJzOiBSZXF1ZXN0UGFyYW1bXTtcbiAgcHJpdmF0ZSByZXF1ZXN0T2JzZXJ2YWJsZXM6IE9ic2VydmFibGU8dW5rbm93bj5bXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbGVzRGF0YVNlcnZpY2U6IFNhbGVzRGF0YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBqc29uVXJsU2VydmljZTogSnNvblVybFNlcnZpY2VcbiAgKSB7XG4gICAgY29uc3QgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7XG4gICAgdGhpcy5uYmFSZXF1ZXN0UGFyYW1ldGVycyA9IE9iamVjdC5rZXlzKFBhcmFtKVxuICAgICAgLm1hcCgocGFyYW0pID0+IHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBuZXcgVVJMKHVybCkuc2VhcmNoUGFyYW1zLmdldChwYXJhbSk7XG4gICAgICAgIHJldHVybiB2YWx1ZSA/IG5ldyBSZXF1ZXN0UGFyYW0ocGFyYW0sIHZhbHVlKSA6IHVuZGVmaW5lZDtcbiAgICAgIH0pXG4gICAgICAuZmlsdGVyKChlbCkgPT4gZWwgIT09IHVuZGVmaW5lZCkgYXMgUmVxdWVzdFBhcmFtW107XG4gIH1cblxuICBwdWJsaWMgdG9OQkFMaXN0KCk6IE9ic2VydmFibGU8TkJBTGlzdD4ge1xuICAgIGlmICh0aGlzLmdldFJlcXVlc3RQYXJhbVZhbHVlKFBhcmFtLnQpICE9PSAnbmJvJykge1xuICAgICAgcmV0dXJuIG9mKG5ldyBOQkFMaXN0KCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlcXVlc3RPYnNlcnZhYmxlcyA9IFtdO1xuICAgICAgdGhpcy5yZXF1ZXN0T2JzZXJ2YWJsZXMucHVzaChcbiAgICAgICAgdGhpcy5zYWxlc0RhdGFTZXJ2aWNlLmdldERlY29tcHJlc3NlZFNhbGVzRGF0YSh0aGlzLmdldFJlcXVlc3RQYXJhbVZhbHVlKFBhcmFtLnNkYXRhKSlcbiAgICAgICk7XG4gICAgICBpZiAodGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZShQYXJhbS50aWQpKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdE9ic2VydmFibGVzLnB1c2goXG4gICAgICAgICAgdGhpcy5kZUNvbXByZXNzUmVxdWVzdFBhcmFtVmFsdWUodGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZShQYXJhbS50aWQpKS5waXBlKFxuICAgICAgICAgICAgbWFwKCh0cmVhdG1lbnRJZDogdW5rbm93bikgPT4gdHJlYXRtZW50SWQpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUGFyYW0ucHQpKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdE9ic2VydmFibGVzLnB1c2goXG4gICAgICAgICAgdGhpcy5kZUNvbXByZXNzUmVxdWVzdFBhcmFtVmFsdWUodGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZShQYXJhbS5wdCkpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHByb2R1Y3RUeXBlOiB1bmtub3duKSA9PiBwcm9kdWN0VHlwZSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZShQYXJhbS5haWQpKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdE9ic2VydmFibGVzLnB1c2goXG4gICAgICAgICAgdGhpcy5kZUNvbXByZXNzUmVxdWVzdFBhcmFtVmFsdWUodGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZShQYXJhbS5haWQpKS5waXBlKG1hcCgobmFtZTogdW5rbm93bikgPT4gbmFtZSkpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3ROYmFMaXN0RnJvbVJlcXVlc3RQYXJhbSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29uc3RydWN0TmJhTGlzdEZyb21SZXF1ZXN0UGFyYW0oKTogT2JzZXJ2YWJsZTxOQkFMaXN0PiB7XG4gICAgcmV0dXJuIGZvcmtKb2luKHRoaXMucmVxdWVzdE9ic2VydmFibGVzKS5waXBlKFxuICAgICAgbWFwKChbc2FsZXNEYXRhRGVjb21wcmVzc2VkLCB0cmVhdG1lbnRJZCwgcHJvZHVjdFR5cGUsIG5hbWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IG5iYSA9IEJ1aWxkZXIoTkJBKVxuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAuc2RhdGEoc2FsZXNEYXRhRGVjb21wcmVzc2VkIGFzIFNhbGVzRGF0YSlcbiAgICAgICAgICAuc2VsbGluZ0FyZ3VtZW50cyh0aGlzLmNyZWF0ZVNlbGxpbmdBcmd1bWVudHModGhpcy5nZXRSZXF1ZXN0UGFyYW1WYWx1ZUFzQXJyYXkoUGFyYW0uc2EpKSlcbiAgICAgICAgICAuY2FtcGFpZ25JZCh0aGlzLmdldFJlcXVlc3RQYXJhbVZhbHVlKFBhcmFtLmNpZCkpXG4gICAgICAgICAgLnRyZWF0bWVudCh0cmVhdG1lbnRJZCA/ICh0cmVhdG1lbnRJZCBhcyBzdHJpbmcpWyd0aWQnXSA6ICcnKVxuICAgICAgICAgIC5wcm9kdWN0VHlwZShwcm9kdWN0VHlwZSA/IChwcm9kdWN0VHlwZSBhcyBzdHJpbmcpWydwdCddIDogJycpXG4gICAgICAgICAgLm5hbWUobmFtZSA/IChuYW1lIGFzIHN0cmluZylbJ2FpZCddIDogJycpXG4gICAgICAgICAgLmJ1aWxkKCk7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBCdWlsZGVyKE5CQUxpc3QpXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAuYWN0aW9ucyhbbmJhXSlcbiAgICAgICAgICAgIC5jaGFubmVsKHRoaXMuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUGFyYW0uc3JjKSlcbiAgICAgICAgICAgIC5pbnRlcmFjdGlvbklkKHRoaXMuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUGFyYW0uZGlkKSlcbiAgICAgICAgICAgIC52KHRoaXMuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUGFyYW0udikpXG4gICAgICAgICAgICAuaXNTdWNjZXNzKHRydWUpXG4gICAgICAgICAgICAuYnVpbGQoKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZXF1ZXN0UGFyYW0oa2V5OiBQYXJhbSk6IFJlcXVlc3RQYXJhbSB7XG4gICAgcmV0dXJuIHRoaXMubmJhUmVxdWVzdFBhcmFtZXRlcnMuZmluZCgocGFyYW0pID0+IHBhcmFtLmtleSA9PT0ga2V5KSBhcyBSZXF1ZXN0UGFyYW07XG4gIH1cblxuICBwcml2YXRlIGdldFJlcXVlc3RQYXJhbVZhbHVlKGtleTogUGFyYW0pOiBzdHJpbmcge1xuICAgIGNvbnN0IHJlcXVlc3RQYXJhbSA9IHRoaXMuZ2V0UmVxdWVzdFBhcmFtKGtleSk7XG4gICAgcmV0dXJuIHJlcXVlc3RQYXJhbSA/IHJlcXVlc3RQYXJhbS52YWx1ZSA6ICcnO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZXF1ZXN0UGFyYW1WYWx1ZUFzQXJyYXkoa2V5OiBQYXJhbSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCByZXF1ZXN0UGFyYW0gPSB0aGlzLmdldFJlcXVlc3RQYXJhbShrZXkpO1xuICAgIHJldHVybiByZXF1ZXN0UGFyYW0gPyByZXF1ZXN0UGFyYW0udmFsdWUuc3BsaXQoJywnKSA6IFtdO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTZWxsaW5nQXJndW1lbnRzKHNhOiBzdHJpbmdbXSk6IFNlbGxpbmdBcmd1bWVudFtdIHtcbiAgICBsZXQgcmFuayA9IDE7XG4gICAgY29uc3Qgc2VsbGluZ0FyZ3VtZW50czogU2VsbGluZ0FyZ3VtZW50W10gPSBbXTtcbiAgICBzYS5mb3JFYWNoKChzYVBhcmFtKSA9PiBzZWxsaW5nQXJndW1lbnRzLnB1c2gobmV3IFNlbGxpbmdBcmd1bWVudChzYVBhcmFtLCByYW5rKyspKSk7XG5cbiAgICByZXR1cm4gc2VsbGluZ0FyZ3VtZW50cztcbiAgfVxuXG4gIHByaXZhdGUgZGVDb21wcmVzc1JlcXVlc3RQYXJhbVZhbHVlKHBhcmFtVmFsdWU6IHN0cmluZyk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLmpzb25VcmxTZXJ2aWNlLmRlY29tcHJlc3MocGFyYW1WYWx1ZSkgYXMgT2JzZXJ2YWJsZTx1bmtub3duPjtcbiAgfVxufVxuIl19