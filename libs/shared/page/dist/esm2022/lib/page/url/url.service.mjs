import { Inject, Injectable } from '@angular/core';
import { find, keyBy, map } from 'lodash-es';
import { QueryParamEnum } from '../enums/query-param.enum';
import { forkJoin, timeout } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@telenet/ng-lib-datalayer";
import * as i2 from "../client-browser-type/client-browser-type.service";
export class UrlService {
    window;
    dataLayerService;
    clientBrowserTypeService;
    constructor(window, dataLayerService, clientBrowserTypeService) {
        this.window = window;
        this.dataLayerService = dataLayerService;
        this.clientBrowserTypeService = clientBrowserTypeService;
    }
    getCurrentUrl() {
        if (this.window.location && this.window.location.href) {
            return this.window.location.href;
        }
        return '';
    }
    openWindow(url) {
        this.window.open(url, '_self');
    }
    openNewTab(url) {
        if (this.clientBrowserTypeService.isClientUsingSafari()) {
            this.openNewTabForSafari(url);
        }
        else {
            this.window.open(url, '_blank');
        }
    }
    reloadWindow() {
        this.window.location.reload();
    }
    getParameterByName(name) {
        const match = RegExp('[?&]' + name + '=([^&]*)').exec(this.window.location.search);
        return match && decodeURIComponent(match[1]);
    }
    getParamsValueFromUrl(url, paramKey) {
        const match = RegExp('[?&]' + paramKey + '=([^&]*)').exec(url);
        return match && decodeURIComponent(match[1]);
    }
    getUrlWithParams(url, params) {
        const keyValues = map(params, (param) => {
            return param.getKeyValue();
        });
        return url + '?' + keyValues.join('&');
    }
    redirectTo(url) {
        const promiseArray = this.dataLayerService.getAnalyticsPromises();
        if (promiseArray?.length === 0) {
            this.window.location.href = url;
        }
        else {
            forkJoin(promiseArray)
                .pipe(timeout(5000) // timeout after 5 seconds
            )
                .subscribe({
                next: () => {
                    this.window.location.href = url;
                },
                error: () => {
                    // This block will be executed if the timeout occurs, this way we can ensure that the user is redirected even if the analytics are not loaded
                    console.warn("Timeout: Datalayer promises couldn't be resolved. Redirecting to the url");
                    this.window.location.href = url;
                },
            });
        }
    }
    doHistoryBack() {
        if (this.window.history) {
            this.window.history.back();
        }
    }
    getRequestParametersAsString() {
        if (this.window.location && this.window.location.search) {
            return this.window.location.search;
        }
        return '';
    }
    getRequestParameters() {
        const obj = {};
        if (this.window.location && this.window.location.search) {
            const pairs = this.window.location.search.substring(1).split('&');
            let keyValue = [];
            pairs.forEach((pair) => {
                if (pair !== '') {
                    keyValue = pair.split('=');
                    obj[decodeURIComponent(keyValue[0])] = decodeURIComponent(keyValue[1]);
                }
            });
        }
        return obj;
    }
    getRequestParameterOrDefault(key, defaultValue) {
        return (find(this.getRequestParameters(), function (_paramValue, paramKey) {
            return paramKey.toLowerCase() === key.toLowerCase();
        }) || defaultValue);
    }
    getRequestParamValue(key, defaultValue) {
        return this.getRequestParameterOrDefault(key, defaultValue);
    }
    requestParamsContains(key) {
        return this.getRequestParameters()[key] !== undefined;
    }
    getHashParameter(key) {
        const hashParam = this.getHashParameters()[key];
        if (hashParam !== undefined) {
            return hashParam.value;
        }
        return null;
    }
    getUrlWithOnlyHashParam() {
        if (this.window && this.window.location && this.window.location.hash) {
            return this.window.location.hash;
        }
        return '';
    }
    removeURLParameters(removeParams) {
        const deleteRegex = new RegExp(removeParams.join('=|') + '=');
        const params = this.window.location.search.slice(1).split('&');
        const search = [];
        for (const value of params) {
            if (value.length > 0 && !deleteRegex.test(value)) {
                search.push(value);
            }
        }
        const path = this.window.location.pathname + (search.length ? '?' + search.join('&') : '') + this.window.location.hash;
        this.window.history.replaceState({}, this.window.document.title, path);
    }
    removeParametersFromUrl(url, parameters) {
        if (!Array.isArray(parameters)) {
            parameters = [parameters];
        }
        if (!url?.startsWith('http')) {
            return url;
        }
        const urlObject = new URL(url);
        const params = urlObject.searchParams;
        parameters.forEach((param) => {
            params.delete(param);
        });
        return urlObject.href;
    }
    replaceURLParameters(data) {
        const params = this.window.location.search.slice(1).split('&');
        const search = [];
        for (const value of params) {
            if (value.length > 0) {
                const split = value.split('=');
                const key = decodeURIComponent(split[0]);
                const newValue = data.find((d) => d.key === key)?.value ?? decodeURIComponent(split[1]);
                search.push(`${encodeURIComponent(key)}=${encodeURIComponent(newValue)}`);
            }
        }
        data
            .filter((d) => !params.find((p) => decodeURIComponent(p.split('=')[0]) === d.key))
            .forEach((d) => search.push(`${encodeURIComponent(d.key)}=${encodeURIComponent(d.value)}`));
        const path = this.window.location.pathname + (search.length ? '?' + search.join('&') : '') + this.window.location.hash;
        this.window.history.replaceState({}, this.window.document.title, path);
    }
    fromSource(value) {
        let source = this.getRequestParamValue(QueryParamEnum.SOURCE, '');
        source = source && source.toUpperCase();
        return source === value.toUpperCase();
    }
    getHashParameters() {
        if (this.window && this.window.location && this.window.location.hash) {
            const hash = this.window.location.hash.replace(/^#/, '');
            if (hash !== '') {
                const pairs = decodeURI(hash).split('/');
                return keyBy(map(pairs, (pair) => {
                    const keyValue = pair.split('=');
                    return {
                        key: keyValue[0],
                        value: keyValue[1],
                    };
                }), (p) => p.key);
            }
        }
        return [];
    }
    buildUrlWithParams(url, params) {
        const paramList = [];
        params.forEach((value, key) => {
            paramList.push(`${key}=${value}`);
        });
        return url + (paramList.length > 0 ? `?${paramList.join('&')}` : '');
    }
    buildUrlWithHashParams(url, params) {
        const paramList = [];
        params.forEach((value, key) => {
            paramList.push(`${key}=${value}`);
        });
        return url + (paramList.length > 0 ? '/#/' + `${paramList.join('/')}` : '');
    }
    getOrigin() {
        return this.window.location.origin;
    }
    getActionParametersRemovedURL() {
        const paramArray = [];
        const params = this.getCurrentUrl().split('&');
        for (const value of params) {
            if (value.length > 0 && value !== 'action=register') {
                paramArray.push(value);
            }
        }
        return paramArray.join('&');
    }
    getParameters(urlString) {
        const url = new URL(urlString);
        const paramMap = new Map();
        for (const [key, value] of url.searchParams.entries()) {
            paramMap.set(key, decodeURIComponent(value));
        }
        return paramMap;
    }
    openNewTabForSafari(url) {
        const anchorElement = this.window.document.createElement('a');
        anchorElement.target = '_blank';
        anchorElement.href = url;
        const event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true,
            detail: 0,
            screenX: 0,
            screenY: 0,
            clientX: 0,
            clientY: 0,
            ctrlKey: false,
            altKey: false,
            shiftKey: false,
            metaKey: false,
            button: 0,
            relatedTarget: null,
        });
        anchorElement.dispatchEvent(event);
    }
    static ɵfac = function UrlService_Factory(t) { return new (t || UrlService)(i0.ɵɵinject('Window'), i0.ɵɵinject(i1.DataLayerService), i0.ɵɵinject(i2.ClientBrowserTypeService)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: UrlService, factory: UrlService.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(UrlService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], () => [{ type: Window, decorators: [{
                type: Inject,
                args: ['Window']
            }] }, { type: i1.DataLayerService }, { type: i2.ClientBrowserTypeService }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL3BhZ2UvdXJsL3VybC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUU3QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFM0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7Ozs7QUFLekMsTUFBTSxPQUFPLFVBQVU7SUFFUztJQUNYO0lBQ0E7SUFIbkIsWUFDOEIsTUFBYyxFQUN6QixnQkFBa0MsRUFDbEMsd0JBQWtEO1FBRnZDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDekIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO0lBQ2xFLENBQUM7SUFFSixhQUFhO1FBQ1gsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN0RCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyxDQUFDO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsVUFBVSxDQUFDLEdBQVc7UUFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxVQUFVLENBQUMsR0FBVztRQUNwQixJQUFJLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUM7WUFDeEQsSUFBSSxDQUFDLG1CQUFt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LFFBQVEsQ0FBQztRQUNoQyxhQUFhLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUV6QixNQUFNLEtBQUssR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLEVBQUU7WUFDcEMsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsSUFBSTtZQUNiLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLE1BQU0sRUFBRSxDQUFDO1lBQ1QsT0FBTyxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsQ0FBQztZQUNWLE9BQU8sRUFBRSxDQUFDO1lBQ1YsT0FBTyxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsS0FBSztZQUNkLE1BQU0sRUFBRSxLQUFLO1lBQ2IsUUFBUSxFQUFFLEtBQUs7WUFDZixPQUFPLEVBQUUsS0FBSztZQUNkLE1BQU0sRUFBRSxDQUFDO1lBQ1QsYUFBYSxFQUFFLElBQUk7U0FDcEIsQ0FBQyxDQUFDO1FBQ0gsYUFBYSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO29FQXJSVSxVQUFVLGNBRVgsUUFBUTtnRUFGUCxVQUFVLFdBQVYsVUFBVSxtQkFGVCxNQUFNOztpRkFFUCxVQUFVO2NBSHRCLFVBQVU7ZUFBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7c0JBR0ksTUFBTTt1QkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXJsUGFyYW0gfSBmcm9tICcuL3VybC1wYXJhbS5tb2RlbCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZpbmQsIGtleUJ5LCBtYXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQ2xpZW50QnJvd3NlclR5cGVTZXJ2aWNlIH0gZnJvbSAnLi4vY2xpZW50LWJyb3dzZXItdHlwZS9jbGllbnQtYnJvd3Nlci10eXBlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUXVlcnlQYXJhbUVudW0gfSBmcm9tICcuLi9lbnVtcy9xdWVyeS1wYXJhbS5lbnVtJztcbmltcG9ydCB7IERhdGFMYXllclNlcnZpY2UgfSBmcm9tICdAdGVsZW5ldC9uZy1saWItZGF0YWxheWVyJztcbmltcG9ydCB7IGZvcmtKb2luLCB0aW1lb3V0IH0gZnJvbSAncnhqcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBVcmxTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdCgnV2luZG93JykgcHJvdGVjdGVkIHdpbmRvdzogV2luZG93LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YUxheWVyU2VydmljZTogRGF0YUxheWVyU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudEJyb3dzZXJUeXBlU2VydmljZTogQ2xpZW50QnJvd3NlclR5cGVTZXJ2aWNlXG4gICkge31cblxuICBnZXRDdXJyZW50VXJsKCk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMud2luZG93LmxvY2F0aW9uICYmIHRoaXMud2luZG93LmxvY2F0aW9uLmhyZWYpIHtcbiAgICAgIHJldHVybiB0aGlzLndpbmRvdy5sb2NhdGlvbi5ocmVmO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBvcGVuV2luZG93KHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy53aW5kb3cub3Blbih1cmwsICdfc2VsZicpO1xuICB9XG5cbiAgb3Blbk5ld1RhYih1cmw6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNsaWVudEJyb3dzZXJUeXBlU2VydmljZS5pc0NsaWVudFVzaW5nU2FmYXJpKCkpIHtcbiAgICAgIHRoaXMub3Blbk5ld1RhYkZvclNhZmFyaSh1cmwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndpbmRvdy5vcGVuKHVybCwgJ19ibGFuaycpO1xuICAgIH1cbiAgfVxuXG4gIHJlbG9hZFdpbmRvdygpIHtcbiAgICB0aGlzLndpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgfVxuXG4gIGdldFBhcmFtZXRlckJ5TmFtZShuYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBtYXRjaCA9IFJlZ0V4cCgnWz8mXScgKyBuYW1lICsgJz0oW14mXSopJykuZXhlYyh0aGlzLndpbmRvdy5sb2NhdGlvbi5zZWFyY2gpO1xuICAgIHJldHVybiBtYXRjaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbMV0pO1xuICB9XG5cbiAgZ2V0UGFyYW1zVmFsdWVGcm9tVXJsKHVybDogc3RyaW5nLCBwYXJhbUtleTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgbWF0Y2ggPSBSZWdFeHAoJ1s/Jl0nICsgcGFyYW1LZXkgKyAnPShbXiZdKiknKS5leGVjKHVybCk7XG4gICAgcmV0dXJuIG1hdGNoICYmIGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSk7XG4gIH1cblxuICBnZXRVcmxXaXRoUGFyYW1zKHVybDogc3RyaW5nLCBwYXJhbXM6IFVybFBhcmFtW10pOiBzdHJpbmcge1xuICAgIGNvbnN0IGtleVZhbHVlcyA9IG1hcChwYXJhbXMsIChwYXJhbSkgPT4ge1xuICAgICAgcmV0dXJuIHBhcmFtLmdldEtleVZhbHVlKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXJsICsgJz8nICsga2V5VmFsdWVzLmpvaW4oJyYnKTtcbiAgfVxuXG4gIHJlZGlyZWN0VG8odXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBwcm9taXNlQXJyYXkgPSB0aGlzLmRhdGFMYXllclNlcnZpY2UuZ2V0QW5hbHl0aWNzUHJvbWlzZXMoKTtcbiAgICBpZiAocHJvbWlzZUFycmF5Py5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMud2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvcmtKb2luKHByb21pc2VBcnJheSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGltZW91dCg1MDAwKSAvLyB0aW1lb3V0IGFmdGVyIDUgc2Vjb25kc1xuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMud2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAgICAgLy8gVGhpcyBibG9jayB3aWxsIGJlIGV4ZWN1dGVkIGlmIHRoZSB0aW1lb3V0IG9jY3VycywgdGhpcyB3YXkgd2UgY2FuIGVuc3VyZSB0aGF0IHRoZSB1c2VyIGlzIHJlZGlyZWN0ZWQgZXZlbiBpZiB0aGUgYW5hbHl0aWNzIGFyZSBub3QgbG9hZGVkXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJUaW1lb3V0OiBEYXRhbGF5ZXIgcHJvbWlzZXMgY291bGRuJ3QgYmUgcmVzb2x2ZWQuIFJlZGlyZWN0aW5nIHRvIHRoZSB1cmxcIik7XG4gICAgICAgICAgICB0aGlzLndpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJsO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGRvSGlzdG9yeUJhY2soKTogdm9pZCB7XG4gICAgaWYgKHRoaXMud2luZG93Lmhpc3RvcnkpIHtcbiAgICAgIHRoaXMud2luZG93Lmhpc3RvcnkuYmFjaygpO1xuICAgIH1cbiAgfVxuXG4gIGdldFJlcXVlc3RQYXJhbWV0ZXJzQXNTdHJpbmcoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy53aW5kb3cubG9jYXRpb24gJiYgdGhpcy53aW5kb3cubG9jYXRpb24uc2VhcmNoKSB7XG4gICAgICByZXR1cm4gdGhpcy53aW5kb3cubG9jYXRpb24uc2VhcmNoO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBnZXRSZXF1ZXN0UGFyYW1ldGVycygpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICBjb25zdCBvYmo6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBpZiAodGhpcy53aW5kb3cubG9jYXRpb24gJiYgdGhpcy53aW5kb3cubG9jYXRpb24uc2VhcmNoKSB7XG4gICAgICBjb25zdCBwYWlycyA9IHRoaXMud2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSkuc3BsaXQoJyYnKTtcbiAgICAgIGxldCBrZXlWYWx1ZTogc3RyaW5nW10gPSBbXTtcbiAgICAgIHBhaXJzLmZvckVhY2goKHBhaXIpID0+IHtcbiAgICAgICAgaWYgKHBhaXIgIT09ICcnKSB7XG4gICAgICAgICAga2V5VmFsdWUgPSBwYWlyLnNwbGl0KCc9Jyk7XG4gICAgICAgICAgb2JqW2RlY29kZVVSSUNvbXBvbmVudChrZXlWYWx1ZVswXSldID0gZGVjb2RlVVJJQ29tcG9uZW50KGtleVZhbHVlWzFdKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICBnZXRSZXF1ZXN0UGFyYW1ldGVyT3JEZWZhdWx0KGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIChcbiAgICAgIGZpbmQodGhpcy5nZXRSZXF1ZXN0UGFyYW1ldGVycygpLCBmdW5jdGlvbiAoX3BhcmFtVmFsdWUsIHBhcmFtS2V5KSB7XG4gICAgICAgIHJldHVybiBwYXJhbUtleS50b0xvd2VyQ2FzZSgpID09PSBrZXkudG9Mb3dlckNhc2UoKTtcbiAgICAgIH0pIHx8IGRlZmF1bHRWYWx1ZVxuICAgICk7XG4gIH1cblxuICBnZXRSZXF1ZXN0UGFyYW1WYWx1ZShrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmdldFJlcXVlc3RQYXJhbWV0ZXJPckRlZmF1bHQoa2V5LCBkZWZhdWx0VmFsdWUpO1xuICB9XG5cbiAgcmVxdWVzdFBhcmFtc0NvbnRhaW5zKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVxdWVzdFBhcmFtZXRlcnMoKVtrZXldICE9PSB1bmRlZmluZWQ7XG4gIH1cblxuICBnZXRIYXNoUGFyYW1ldGVyKGtleTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgaGFzaFBhcmFtID0gdGhpcy5nZXRIYXNoUGFyYW1ldGVycygpW2tleV07XG5cbiAgICBpZiAoaGFzaFBhcmFtICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBoYXNoUGFyYW0udmFsdWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXRVcmxXaXRoT25seUhhc2hQYXJhbSgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLndpbmRvdyAmJiB0aGlzLndpbmRvdy5sb2NhdGlvbiAmJiB0aGlzLndpbmRvdy5sb2NhdGlvbi5oYXNoKSB7XG4gICAgICByZXR1cm4gdGhpcy53aW5kb3cubG9jYXRpb24uaGFzaDtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgcmVtb3ZlVVJMUGFyYW1ldGVycyhyZW1vdmVQYXJhbXM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgZGVsZXRlUmVnZXggPSBuZXcgUmVnRXhwKHJlbW92ZVBhcmFtcy5qb2luKCc9fCcpICsgJz0nKTtcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLndpbmRvdy5sb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTtcbiAgICBjb25zdCBzZWFyY2g6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCB2YWx1ZSBvZiBwYXJhbXMpIHtcbiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwICYmICFkZWxldGVSZWdleC50ZXN0KHZhbHVlKSkge1xuICAgICAgICBzZWFyY2gucHVzaCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHBhdGggPVxuICAgICAgdGhpcy53aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyAoc2VhcmNoLmxlbmd0aCA/ICc/JyArIHNlYXJjaC5qb2luKCcmJykgOiAnJykgKyB0aGlzLndpbmRvdy5sb2NhdGlvbi5oYXNoO1xuICAgIHRoaXMud2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCB0aGlzLndpbmRvdy5kb2N1bWVudC50aXRsZSwgcGF0aCk7XG4gIH1cblxuICByZW1vdmVQYXJhbWV0ZXJzRnJvbVVybCh1cmw6IHN0cmluZywgcGFyYW1ldGVyczogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkocGFyYW1ldGVycykpIHtcbiAgICAgIHBhcmFtZXRlcnMgPSBbcGFyYW1ldGVyc107XG4gICAgfVxuXG4gICAgaWYgKCF1cmw/LnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgcmV0dXJuIHVybDtcbiAgICB9XG4gICAgY29uc3QgdXJsT2JqZWN0ID0gbmV3IFVSTCh1cmwpO1xuICAgIGNvbnN0IHBhcmFtcyA9IHVybE9iamVjdC5zZWFyY2hQYXJhbXM7XG4gICAgcGFyYW1ldGVycy5mb3JFYWNoKChwYXJhbSkgPT4ge1xuICAgICAgcGFyYW1zLmRlbGV0ZShwYXJhbSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXJsT2JqZWN0LmhyZWY7XG4gIH1cblxuICByZXBsYWNlVVJMUGFyYW1ldGVycyhkYXRhOiB7IGtleTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH1bXSkge1xuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMud2luZG93LmxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpO1xuICAgIGNvbnN0IHNlYXJjaDogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHBhcmFtcykge1xuICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3Qgc3BsaXQgPSB2YWx1ZS5zcGxpdCgnPScpO1xuICAgICAgICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQoc3BsaXRbMF0pO1xuICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IGRhdGEuZmluZCgoZCkgPT4gZC5rZXkgPT09IGtleSk/LnZhbHVlID8/IGRlY29kZVVSSUNvbXBvbmVudChzcGxpdFsxXSk7XG4gICAgICAgIHNlYXJjaC5wdXNoKGAke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfT0ke2VuY29kZVVSSUNvbXBvbmVudChuZXdWYWx1ZSl9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGRhdGFcbiAgICAgIC5maWx0ZXIoKGQpID0+ICFwYXJhbXMuZmluZCgocCkgPT4gZGVjb2RlVVJJQ29tcG9uZW50KHAuc3BsaXQoJz0nKVswXSkgPT09IGQua2V5KSlcbiAgICAgIC5mb3JFYWNoKChkKSA9PiBzZWFyY2gucHVzaChgJHtlbmNvZGVVUklDb21wb25lbnQoZC5rZXkpfT0ke2VuY29kZVVSSUNvbXBvbmVudChkLnZhbHVlKX1gKSk7XG4gICAgY29uc3QgcGF0aCA9XG4gICAgICB0aGlzLndpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIChzZWFyY2gubGVuZ3RoID8gJz8nICsgc2VhcmNoLmpvaW4oJyYnKSA6ICcnKSArIHRoaXMud2luZG93LmxvY2F0aW9uLmhhc2g7XG4gICAgdGhpcy53aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIHRoaXMud2luZG93LmRvY3VtZW50LnRpdGxlLCBwYXRoKTtcbiAgfVxuXG4gIGZyb21Tb3VyY2UodmFsdWU6IFF1ZXJ5UGFyYW1FbnVtKTogYm9vbGVhbiB7XG4gICAgbGV0IHNvdXJjZSA9IHRoaXMuZ2V0UmVxdWVzdFBhcmFtVmFsdWUoUXVlcnlQYXJhbUVudW0uU09VUkNFLCAnJyk7XG4gICAgc291cmNlID0gc291cmNlICYmIHNvdXJjZS50b1VwcGVyQ2FzZSgpO1xuICAgIHJldHVybiBzb3VyY2UgPT09IHZhbHVlLnRvVXBwZXJDYXNlKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0SGFzaFBhcmFtZXRlcnMoKSB7XG4gICAgaWYgKHRoaXMud2luZG93ICYmIHRoaXMud2luZG93LmxvY2F0aW9uICYmIHRoaXMud2luZG93LmxvY2F0aW9uLmhhc2gpIHtcbiAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLndpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoL14jLywgJycpO1xuXG4gICAgICBpZiAoaGFzaCAhPT0gJycpIHtcbiAgICAgICAgY29uc3QgcGFpcnMgPSBkZWNvZGVVUkkoaGFzaCkuc3BsaXQoJy8nKTtcblxuICAgICAgICByZXR1cm4ga2V5QnkoXG4gICAgICAgICAgbWFwKHBhaXJzLCAocGFpcikgPT4ge1xuICAgICAgICAgICAgY29uc3Qga2V5VmFsdWUgPSBwYWlyLnNwbGl0KCc9Jyk7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGtleToga2V5VmFsdWVbMF0sXG4gICAgICAgICAgICAgIHZhbHVlOiBrZXlWYWx1ZVsxXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSksXG4gICAgICAgICAgKHApID0+IHAua2V5XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHB1YmxpYyBidWlsZFVybFdpdGhQYXJhbXModXJsOiBzdHJpbmcsIHBhcmFtczogTWFwPHN0cmluZywgc3RyaW5nPik6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW1MaXN0OiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgcGFyYW1zLmZvckVhY2goKHZhbHVlOiBzdHJpbmcsIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICBwYXJhbUxpc3QucHVzaChgJHtrZXl9PSR7dmFsdWV9YCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXJsICsgKHBhcmFtTGlzdC5sZW5ndGggPiAwID8gYD8ke3BhcmFtTGlzdC5qb2luKCcmJyl9YCA6ICcnKTtcbiAgfVxuXG4gIHB1YmxpYyBidWlsZFVybFdpdGhIYXNoUGFyYW1zKHVybDogc3RyaW5nLCBwYXJhbXM6IE1hcDxzdHJpbmcsIHN0cmluZz4pOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhcmFtTGlzdDogc3RyaW5nW10gPSBbXTtcblxuICAgIHBhcmFtcy5mb3JFYWNoKCh2YWx1ZTogc3RyaW5nLCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgcGFyYW1MaXN0LnB1c2goYCR7a2V5fT0ke3ZhbHVlfWApO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVybCArIChwYXJhbUxpc3QubGVuZ3RoID4gMCA/ICcvIy8nICsgYCR7cGFyYW1MaXN0LmpvaW4oJy8nKX1gIDogJycpO1xuICB9XG5cbiAgZ2V0T3JpZ2luKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMud2luZG93LmxvY2F0aW9uLm9yaWdpbjtcbiAgfVxuXG4gIGdldEFjdGlvblBhcmFtZXRlcnNSZW1vdmVkVVJMKCk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW1BcnJheTogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmdldEN1cnJlbnRVcmwoKS5zcGxpdCgnJicpO1xuICAgIGZvciAoY29uc3QgdmFsdWUgb2YgcGFyYW1zKSB7XG4gICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCAmJiB2YWx1ZSAhPT0gJ2FjdGlvbj1yZWdpc3RlcicpIHtcbiAgICAgICAgcGFyYW1BcnJheS5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtQXJyYXkuam9pbignJicpO1xuICB9XG5cbiAgZ2V0UGFyYW1ldGVycyh1cmxTdHJpbmc6IHN0cmluZyk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodXJsU3RyaW5nKTtcbiAgICBjb25zdCBwYXJhbU1hcCA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB1cmwuc2VhcmNoUGFyYW1zLmVudHJpZXMoKSkge1xuICAgICAgcGFyYW1NYXAuc2V0KGtleSwgZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmFtTWFwO1xuICB9XG5cbiAgcHJpdmF0ZSBvcGVuTmV3VGFiRm9yU2FmYXJpKHVybDogc3RyaW5nKSB7XG4gICAgY29uc3QgYW5jaG9yRWxlbWVudCA9IHRoaXMud2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICBhbmNob3JFbGVtZW50LnRhcmdldCA9ICdfYmxhbmsnO1xuICAgIGFuY2hvckVsZW1lbnQuaHJlZiA9IHVybDtcblxuICAgIGNvbnN0IGV2ZW50ID0gbmV3IE1vdXNlRXZlbnQoJ2NsaWNrJywge1xuICAgICAgdmlldzogd2luZG93LFxuICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgIGNhbmNlbGFibGU6IHRydWUsXG4gICAgICBkZXRhaWw6IDAsXG4gICAgICBzY3JlZW5YOiAwLFxuICAgICAgc2NyZWVuWTogMCxcbiAgICAgIGNsaWVudFg6IDAsXG4gICAgICBjbGllbnRZOiAwLFxuICAgICAgY3RybEtleTogZmFsc2UsXG4gICAgICBhbHRLZXk6IGZhbHNlLFxuICAgICAgc2hpZnRLZXk6IGZhbHNlLFxuICAgICAgbWV0YUtleTogZmFsc2UsXG4gICAgICBidXR0b246IDAsXG4gICAgICByZWxhdGVkVGFyZ2V0OiBudWxsLFxuICAgIH0pO1xuICAgIGFuY2hvckVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gIH1cbn1cbiJdfQ==