var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
import { ReplaySubject } from 'rxjs';
import { ContexthubConstants } from '../constants/contexthub.constant';
import { Inject } from '@angular/core';
import { EventCategoryEnum, EventTypeEnum } from '@telenet/ng-lib-datalayer';
import { DirectCallLabelEnum } from 'udl';
let ContextHubGenericStoreService = class ContextHubGenericStoreService {
    _ngZone;
    window;
    dataLayerService;
    storeConfig;
    STORE_DATA_LOADED_CALL_LABEL = 'store_data_loaded';
    contextHubSubject = new ReplaySubject(1);
    isGetDataCallInvoked = false;
    constructor(_ngZone, window, dataLayerService, storeConfig) {
        this._ngZone = _ngZone;
        this.window = window;
        this.dataLayerService = dataLayerService;
        this.storeConfig = storeConfig;
        this.registerAngularService();
        this.registerStoreEventHook();
    }
    enrich(_data) {
        throw new Error('Method not Supported');
    }
    onLoadData(_data) {
        throw new Error('Method not Supported');
    }
    getStoreData() {
        const store = this.getStore();
        if (store) {
            const uniqueBindIdentifier = store.name + '_store_ready';
            const triggerForPastEvents = true;
            store.eventing.once(ContexthubConstants.EVENT_STORE_READY, () => {
                if (!this.isGetDataCallInvoked) {
                    this.isGetDataCallInvoked = true;
                    store.getData(true);
                }
            }, uniqueBindIdentifier, triggerForPastEvents);
        }
        return this.contextHubSubject;
    }
    updateStoreData(data, updateTimestamp = true) {
        const store = this.getStore();
        store?.updateStoreData(data, updateTimestamp);
    }
    onStoreDataLoaded(storeDataObj) {
        if (this.contextHubSubject) {
            storeDataObj = this.handleEnrich(storeDataObj);
            this.contextHubSubject.next(storeDataObj);
            this.contextHubSubject.complete();
            this.contextHubSubject = new ReplaySubject(1);
            this.isGetDataCallInvoked = false;
        }
    }
    registerAngularService() {
        if (!this.window[ContexthubConstants.ANGULAR_STORE_SERVICE_REF]) {
            this.window[ContexthubConstants.ANGULAR_STORE_SERVICE_REF] = {};
        }
        const angularStoreServiceRef = this.window[ContexthubConstants.ANGULAR_STORE_SERVICE_REF];
        if (angularStoreServiceRef) {
            angularStoreServiceRef[this.storeConfig.serviceName] = { service: this, zone: this._ngZone };
        }
    }
    getStore() {
        const contextHub = this.window[ContexthubConstants.CONTEXTHUB];
        if (contextHub === undefined || contextHub === null || contextHub?.getStore === null) {
            return null;
        }
        return contextHub.getStore?.(this.storeConfig.storeName);
    }
    handleEnrich(storeData) {
        try {
            return this.enrich(storeData);
        }
        catch (e) {
            if (this.storeConfig.storeModel?.enrich) {
                return this.storeConfig.storeModel.enrich(storeData);
            }
            return {};
        }
    }
    registerStoreEventHook() {
        const store = this.getStore();
        if (store === null) {
            return;
        }
        this.sendDataLayerEventOnStoreEvent(store, this.STORE_DATA_LOADED_CALL_LABEL, DirectCallLabelEnum.STORE_DATA_LOADED);
    }
    sendDataLayerEventOnStoreEvent(store, storeEvent, directCallLabel) {
        const triggerForPastEvents = true;
        store.eventing['once'](storeEvent + ':' + store.name, () => this.sendDataLayerStoreEvent('contexthub ' + storeEvent, directCallLabel, store), store.name + '_' + storeEvent, triggerForPastEvents);
    }
    sendDataLayerStoreEvent(eventName, directCallLabel, store) {
        const eventInfoData = this.dataLayerService.createEventInfo(eventName, EventTypeEnum.EVENT_TYPE_CH_STORE);
        const category = this.dataLayerService.createCategory(EventCategoryEnum.PRIMARY_CATEGORY_GENERAL);
        const attributes = {
            storeName: store.name,
        };
        this.dataLayerService.sendEvent({ eventInfo: eventInfoData, attributes, category, directCallLabel });
    }
};
ContextHubGenericStoreService = __decorate([
    __param(1, Inject('Window'))
], ContextHubGenericStoreService);
export { ContextHubGenericStoreService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1odWItZ2VuZXJpYy1zdG9yZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb250ZXh0aHViL3NlcnZpY2VzL2NvbnRleHQtaHViLWdlbmVyaWMtc3RvcmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEVBQWMsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBR3ZFLE9BQU8sRUFBRSxNQUFNLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDL0MsT0FBTyxFQUF5QyxpQkFBaUIsRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNwSCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFFbkMsSUFBTSw2QkFBNkIsR0FBbkMsTUFBTSw2QkFBNkI7SUFRNUI7SUFDa0I7SUFDbEI7SUFDQTtJQVZPLDRCQUE0QixHQUFHLG1CQUFtQixDQUFDO0lBRTVELGlCQUFpQixHQUFxQixJQUFJLGFBQWEsQ0FBSSxDQUFDLENBQUMsQ0FBQztJQUVoRSxvQkFBb0IsR0FBRyxLQUFLLENBQUM7SUFFckMsWUFDWSxPQUFlLEVBQ0csTUFBYyxFQUNoQyxnQkFBa0MsRUFDbEMsV0FBOEM7UUFIOUMsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNHLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDaEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxnQkFBVyxHQUFYLFdBQVcsQ0FBbUM7UUFFeEQsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUNELE1BQU0sQ0FBSSxLQUFRO1FBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUMxQyxD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QUFpQixDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDbEcsTUFBTSxVQUFVLEdBQXdCO1lBQ3RDLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSTtTQUN0QixDQUFDO1FBRUYsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZHLENBQUM7Q0FDRixDQUFBO0FBL0hZLDZCQUE2QjtJQVNyQyxXQUFBLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtHQVRSLDZCQUE2QixDQStIekMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb250ZXh0aHViQ29uc3RhbnRzIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbnRleHRodWIuY29uc3RhbnQnO1xuaW1wb3J0IHsgQ29udGV4dEh1Yk1vZGVsSW50ZXJmYWNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jb250ZXh0LWh1Yi1tb2RlbC1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ29udGV4dEh1YlN0b3JlQ29uZmlnSW50ZXJmYWNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jb250ZXh0LWh1Yi1zdG9yZS1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IEluamVjdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEYXRhTGF5ZXJBdHRyaWJ1dGVzLCBEYXRhTGF5ZXJTZXJ2aWNlLCBFdmVudENhdGVnb3J5RW51bSwgRXZlbnRUeXBlRW51bSB9IGZyb20gJ0B0ZWxlbmV0L25nLWxpYi1kYXRhbGF5ZXInO1xuaW1wb3J0IHsgRGlyZWN0Q2FsbExhYmVsRW51bSB9IGZyb20gJ3VkbCc7XG5cbmV4cG9ydCBjbGFzcyBDb250ZXh0SHViR2VuZXJpY1N0b3JlU2VydmljZTxUIGV4dGVuZHMgQ29udGV4dEh1Yk1vZGVsSW50ZXJmYWNlPFQ+PiB7XG4gIHByb3RlY3RlZCByZWFkb25seSBTVE9SRV9EQVRBX0xPQURFRF9DQUxMX0xBQkVMID0gJ3N0b3JlX2RhdGFfbG9hZGVkJztcblxuICBwcm90ZWN0ZWQgY29udGV4dEh1YlN1YmplY3Q6IFJlcGxheVN1YmplY3Q8VD4gPSBuZXcgUmVwbGF5U3ViamVjdDxUPigxKTtcblxuICBwcml2YXRlIGlzR2V0RGF0YUNhbGxJbnZva2VkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIF9uZ1pvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KCdXaW5kb3cnKSBwcm90ZWN0ZWQgd2luZG93OiBXaW5kb3csXG4gICAgcHJvdGVjdGVkIGRhdGFMYXllclNlcnZpY2U6IERhdGFMYXllclNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHN0b3JlQ29uZmlnOiBDb250ZXh0SHViU3RvcmVDb25maWdJbnRlcmZhY2U8VD5cbiAgKSB7XG4gICAgdGhpcy5yZWdpc3RlckFuZ3VsYXJTZXJ2aWNlKCk7XG4gICAgdGhpcy5yZWdpc3RlclN0b3JlRXZlbnRIb29rKCk7XG4gIH1cbiAgZW5yaWNoPFA+KF9kYXRhOiBQKTogVCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IFN1cHBvcnRlZCcpO1xuICB9XG4gIG9uTG9hZERhdGE8UD4oX2RhdGE/OiBQKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IFN1cHBvcnRlZCcpO1xuICB9XG5cbiAgZ2V0U3RvcmVEYXRhKCk6IFJlcGxheVN1YmplY3Q8VD4ge1xuICAgIGNvbnN0IHN0b3JlID0gdGhpcy5nZXRTdG9yZSgpO1xuICAgIGlmIChzdG9yZSkge1xuICAgICAgY29uc3QgdW5pcXVlQmluZElkZW50aWZpZXIgPSBzdG9yZS5uYW1lICsgJ19zdG9yZV9yZWFkeSc7XG4gICAgICBjb25zdCB0cmlnZ2VyRm9yUGFzdEV2ZW50cyA9IHRydWU7XG4gICAgICBzdG9yZS5ldmVudGluZy5vbmNlKFxuICAgICAgICBDb250ZXh0aHViQ29uc3RhbnRzLkVWRU5UX1NUT1JFX1JFQURZLFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgaWYgKCF0aGlzLmlzR2V0RGF0YUNhbGxJbnZva2VkKSB7XG4gICAgICAgICAgICB0aGlzLmlzR2V0RGF0YUNhbGxJbnZva2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHN0b3JlLmdldERhdGEodHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB1bmlxdWVCaW5kSWRlbnRpZmllcixcbiAgICAgICAgdHJpZ2dlckZvclBhc3RFdmVudHNcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuY29udGV4dEh1YlN1YmplY3Q7XG4gIH1cblxuICB1cGRhdGVTdG9yZURhdGE8UERhdGE+KGRhdGE6IFBEYXRhLCB1cGRhdGVUaW1lc3RhbXA6IGJvb2xlYW4gPSB0cnVlKTogdm9pZCB7XG4gICAgY29uc3Qgc3RvcmUgPSB0aGlzLmdldFN0b3JlKCk7XG4gICAgc3RvcmU/LnVwZGF0ZVN0b3JlRGF0YShkYXRhLCB1cGRhdGVUaW1lc3RhbXApO1xuICB9XG5cbiAgb25TdG9yZURhdGFMb2FkZWQoc3RvcmVEYXRhT2JqOiBUKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29udGV4dEh1YlN1YmplY3QpIHtcbiAgICAgIHN0b3JlRGF0YU9iaiA9IHRoaXMuaGFuZGxlRW5yaWNoKHN0b3JlRGF0YU9iaik7XG4gICAgICB0aGlzLmNvbnRleHRIdWJTdWJqZWN0Lm5leHQoc3RvcmVEYXRhT2JqKTtcbiAgICAgIHRoaXMuY29udGV4dEh1YlN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgIHRoaXMuY29udGV4dEh1YlN1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxUPigxKTtcbiAgICAgIHRoaXMuaXNHZXREYXRhQ2FsbEludm9rZWQgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyQW5ndWxhclNlcnZpY2UoKSB7XG4gICAgaWYgKCF0aGlzLndpbmRvd1tDb250ZXh0aHViQ29uc3RhbnRzLkFOR1VMQVJfU1RPUkVfU0VSVklDRV9SRUZdKSB7XG4gICAgICB0aGlzLndpbmRvd1tDb250ZXh0aHViQ29uc3RhbnRzLkFOR1VMQVJfU1RPUkVfU0VSVklDRV9SRUZdID0ge307XG4gICAgfVxuXG4gICAgY29uc3QgYW5ndWxhclN0b3JlU2VydmljZVJlZiA9IHRoaXMud2luZG93W0NvbnRleHRodWJDb25zdGFudHMuQU5HVUxBUl9TVE9SRV9TRVJWSUNFX1JFRl07XG4gICAgaWYgKGFuZ3VsYXJTdG9yZVNlcnZpY2VSZWYpIHtcbiAgICAgIGFuZ3VsYXJTdG9yZVNlcnZpY2VSZWZbdGhpcy5zdG9yZUNvbmZpZy5zZXJ2aWNlTmFtZV0gPSB7IHNlcnZpY2U6IHRoaXMsIHpvbmU6IHRoaXMuX25nWm9uZSB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RvcmUoKSB7XG4gICAgY29uc3QgY29udGV4dEh1YiA9IHRoaXMud2luZG93W0NvbnRleHRodWJDb25zdGFudHMuQ09OVEVYVEhVQl07XG4gICAgaWYgKGNvbnRleHRIdWIgPT09IHVuZGVmaW5lZCB8fCBjb250ZXh0SHViID09PSBudWxsIHx8IGNvbnRleHRIdWI/LmdldFN0b3JlID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29udGV4dEh1Yi5nZXRTdG9yZT8uKHRoaXMuc3RvcmVDb25maWcuc3RvcmVOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRW5yaWNoPFBEYXRhPihzdG9yZURhdGE6IFBEYXRhKTogVCB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiB0aGlzLmVucmljaChzdG9yZURhdGEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICh0aGlzLnN0b3JlQ29uZmlnLnN0b3JlTW9kZWw/LmVucmljaCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdG9yZUNvbmZpZy5zdG9yZU1vZGVsLmVucmljaChzdG9yZURhdGEpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge30gYXMgVDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyU3RvcmVFdmVudEhvb2soKSB7XG4gICAgY29uc3Qgc3RvcmUgPSB0aGlzLmdldFN0b3JlKCk7XG4gICAgaWYgKHN0b3JlID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zZW5kRGF0YUxheWVyRXZlbnRPblN0b3JlRXZlbnQoXG4gICAgICBzdG9yZSxcbiAgICAgIHRoaXMuU1RPUkVfREFUQV9MT0FERURfQ0FMTF9MQUJFTCxcbiAgICAgIERpcmVjdENhbGxMYWJlbEVudW0uU1RPUkVfREFUQV9MT0FERURcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZW5kRGF0YUxheWVyRXZlbnRPblN0b3JlRXZlbnQoXG4gICAgc3RvcmU6IFN0b3JlSW50ZXJmYWNlLFxuICAgIHN0b3JlRXZlbnQ6IHN0cmluZyxcbiAgICBkaXJlY3RDYWxsTGFiZWw6IERpcmVjdENhbGxMYWJlbEVudW1cbiAgKSB7XG4gICAgY29uc3QgdHJpZ2dlckZvclBhc3RFdmVudHMgPSB0cnVlO1xuICAgIHN0b3JlLmV2ZW50aW5nWydvbmNlJ10oXG4gICAgICBzdG9yZUV2ZW50ICsgJzonICsgc3RvcmUubmFtZSxcbiAgICAgICgpID0+IHRoaXMuc2VuZERhdGFMYXllclN0b3JlRXZlbnQoJ2NvbnRleHRodWIgJyArIHN0b3JlRXZlbnQsIGRpcmVjdENhbGxMYWJlbCwgc3RvcmUpLFxuICAgICAgc3RvcmUubmFtZSArICdfJyArIHN0b3JlRXZlbnQsXG4gICAgICB0cmlnZ2VyRm9yUGFzdEV2ZW50c1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNlbmREYXRhTGF5ZXJTdG9yZUV2ZW50KGV2ZW50TmFtZTogc3RyaW5nLCBkaXJlY3RDYWxsTGFiZWw6IERpcmVjdENhbGxMYWJlbEVudW0sIHN0b3JlOiBTdG9yZUludGVyZmFjZSkge1xuICAgIGNvbnN0IGV2ZW50SW5mb0RhdGEgPSB0aGlzLmRhdGFMYXllclNlcnZpY2UuY3JlYXRlRXZlbnRJbmZvKGV2ZW50TmFtZSwgRXZlbnRUeXBlRW51bS5FVkVOVF9UWVBFX0NIX1NUT1JFKTtcbiAgICBjb25zdCBjYXRlZ29yeSA9IHRoaXMuZGF0YUxheWVyU2VydmljZS5jcmVhdGVDYXRlZ29yeShFdmVudENhdGVnb3J5RW51bS5QUklNQVJZX0NBVEVHT1JZX0dFTkVSQUwpO1xuICAgIGNvbnN0IGF0dHJpYnV0ZXM6IERhdGFMYXllckF0dHJpYnV0ZXMgPSB7XG4gICAgICBzdG9yZU5hbWU6IHN0b3JlLm5hbWUsXG4gICAgfTtcblxuICAgIHRoaXMuZGF0YUxheWVyU2VydmljZS5zZW5kRXZlbnQoeyBldmVudEluZm86IGV2ZW50SW5mb0RhdGEsIGF0dHJpYnV0ZXMsIGNhdGVnb3J5LCBkaXJlY3RDYWxsTGFiZWwgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdG9yZUludGVyZmFjZSB7XG4gIGV2ZW50aW5nOiBSZWNvcmQ8c3RyaW5nLCAoLi4uYXJnczogdW5rbm93bltdKSA9PiBib29sZWFuIHwgdW5kZWZpbmVkPjtcbiAgbmFtZTogc3RyaW5nO1xufVxuIl19